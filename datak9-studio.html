<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataK9 Studio - Your IDE for Data Quality</title>

    <!--
        DataK9 Studio - Professional IDE for Data Validation Configuration
        Version: 1.0.0

        This is a comprehensive IDE-style interface for creating and modifying
        YAML configuration files for the DataK9 data validation framework.

        Features:
        - Visual configuration builder with 22 validation types
        - Live YAML editor with syntax highlighting (Monaco Editor)
        - Two-way sync between UI and YAML
        - Validation catalog with comprehensive documentation
        - Import/Export YAML configurations
        - Project wizard for guided setup
        - Context-sensitive help system
        - Auto-save to localStorage
        - Professional dark theme inspired by VS Code
    -->

    <style>
        /* ============================================================================
           DataK9 Studio Brand Colors and Theme
           ============================================================================

           Primary Brand Identity:
           - Name: DataK9 Studio (K9 = canine/dog theme)
           - Tagline: "Your IDE for data quality"
           - Theme: Professional dark IDE with dog/guardian metaphor

           Color Palette:
           - K9 Blue: #4A90E2 (primary action color, representing trust/reliability)
           - Guard Orange: #FF8C42 (accent color, representing vigilance/alerts)
           - Dark Slate: #1E1E1E (main background, IDE standard)
           - Panel Gray: #252526 (panel backgrounds)
           - Border Gray: #3E3E42 (borders and dividers)
           - Text White: #D4D4D4 (primary text)
           - Text Muted: #858585 (secondary text)
           - Success Green: #4EC9B0 (validation success)
           - Warning Yellow: #DCDCAA (warnings)
           - Error Red: #F48771 (errors)
        */

        :root {
            /* Primary Brand Colors */
            --k9-blue: #4A90E2;
            --k9-blue-hover: #5BA3F5;
            --k9-blue-dark: #3A7BC8;
            --guard-orange: #FF8C42;
            --guard-orange-hover: #FFA366;

            /* Background Colors */
            --bg-dark: #1E1E1E;
            --bg-panel: #252526;
            --bg-panel-hover: #2A2D2E;
            --bg-input: #3C3C3C;
            --bg-sidebar: #252526;

            /* Border Colors */
            --border-main: #3E3E42;
            --border-focus: var(--k9-blue);

            /* Text Colors */
            --text-primary: #D4D4D4;
            --text-secondary: #858585;
            --text-muted: #6A6A6A;

            /* Status Colors */
            --status-success: #4EC9B0;
            --status-warning: #DCDCAA;
            --status-error: #F48771;
            --status-info: var(--k9-blue);

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* Typography */
            --font-sans: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            --font-mono: 'Consolas', 'SF Mono', 'Monaco', 'Courier New', monospace;

            /* Layout Dimensions */
            --sidebar-width: 280px;
            --help-panel-width: 320px;
            --menu-height: 35px;
            --bottom-panel-height: 200px;
        }

        /* ============================================================================
           Global Reset and Base Styles
           ============================================================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            font-size: 14px;
            line-height: 1.6;
        }

        /* ============================================================================
           Main Layout Structure
           ============================================================================

           Layout hierarchy:
           - app-container: Full viewport container
             - menu-bar: Top menu (File, Edit, View, Help)
             - app-body: Main content area
               - sidebar: Left navigation panel
               - main-area: Center editor area
                 - editor-container: Visual builder and YAML editor
               - help-panel: Right context help
             - bottom-panel: Footer with export and status
        */

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* ============================================================================
           Menu Bar
           ============================================================================ */

        .menu-bar {
            height: var(--menu-height);
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border-main);
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-md);
            gap: var(--spacing-md);
            flex-shrink: 0;
        }

        .menu-item {
            color: var(--text-primary);
            padding: 4px 12px;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background-color: var(--bg-panel-hover);
        }

        /* Phase 5: Dropdown Menu Styles */
        .menu-item {
            position: relative;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-main);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 220px;
            z-index: 10000;
            margin-top: 2px;
        }

        .menu-item.active .menu-dropdown {
            display: block;
        }

        .menu-dropdown-item {
            padding: 8px 16px;
            cursor: pointer;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .menu-dropdown-item:last-child {
            border-bottom: none;
        }

        .menu-dropdown-item:hover:not(.disabled) {
            background-color: var(--bg-panel-hover);
        }

        .menu-dropdown-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .menu-dropdown-item.separator {
            height: 1px;
            padding: 0;
            margin: 4px 0;
            background-color: var(--border-main);
            cursor: default;
        }

        .menu-dropdown-item .shortcut {
            color: var(--text-secondary);
            font-size: 11px;
            margin-left: 24px;
        }

        .app-title {
            font-size: 13px;
            color: var(--text-secondary);
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-title .logo {
            font-size: 16px;
        }

        /* ============================================================================
           App Body (Main Content Area)
           ============================================================================ */

        .app-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ============================================================================
           Sidebar (Left Navigation Panel)
           ============================================================================

           The sidebar displays:
           - Project tree showing files and their validations
           - Add File button
           - File management controls
        */

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-main);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-main);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h3 {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-sm);
        }

        /* Configuration Navigation Styles */
        .config-section {
            margin-bottom: var(--spacing-md);
        }

        .config-section-header {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .project-settings-item {
            margin-bottom: var(--spacing-sm);
            border: 1px solid var(--border-main);
            border-radius: 4px;
            background-color: var(--bg-panel);
            overflow: hidden;
        }

        .project-settings-header {
            padding: var(--spacing-sm) var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: var(--k9-blue);
            color: white;
        }

        .project-settings-header:hover {
            background-color: #3d7ac2;
        }

        .project-settings-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
        }

        .project-settings-icon {
            font-size: 16px;
        }

        .project-settings-title {
            font-size: 13px;
            font-weight: 600;
        }

        .project-settings-content {
            padding: var(--spacing-md);
            background-color: var(--bg-dark);
            display: none;
        }

        .project-settings-content.expanded {
            display: block;
        }

        .settings-field {
            margin-bottom: var(--spacing-md);
        }

        .settings-field label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .settings-field input[type="text"],
        .settings-field textarea,
        .settings-field input[type="number"],
        .settings-field select {
            width: 100%;
            padding: var(--spacing-sm);
            background: var(--bg-panel);
            border: 1px solid var(--border-main);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
        }

        .settings-field textarea {
            resize: vertical;
            min-height: 60px;
        }

        .settings-field input:focus,
        .settings-field textarea:focus,
        .settings-field select:focus {
            outline: none;
            border-color: var(--k9-blue);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        /* File Tree Styles */
        .file-item {
            margin-bottom: var(--spacing-sm);
            border: 1px solid var(--border-main);
            border-radius: 4px;
            background-color: var(--bg-panel);
            overflow: hidden;
        }

        .file-header {
            padding: var(--spacing-sm) var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .file-header:hover {
            background-color: var(--bg-panel-hover);
        }

        .file-header.selected {
            background-color: var(--k9-blue);
            color: white;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
        }

        .file-icon {
            font-size: 16px;
        }

        .file-name {
            font-size: 13px;
            font-weight: 500;
        }

        .file-format-badge {
            font-size: 10px;
            padding: 2px 6px;
            background-color: var(--k9-blue);
            color: white;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .file-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .file-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .file-action-btn:hover {
            opacity: 1;
            color: var(--text-primary);
        }

        .validations-list {
            padding: var(--spacing-sm);
            background-color: var(--bg-dark);
            display: none;
        }

        .file-item.expanded .validations-list {
            display: block;
        }

        .validation-item {
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            background-color: var(--bg-panel);
            border-left: 3px solid var(--k9-blue);
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .validation-item:hover {
            background-color: var(--bg-panel-hover);
            transform: translateX(4px);
        }

        .validation-item.selected {
            background-color: var(--k9-blue);
            color: white;
        }

        .validation-item.error-severity {
            border-left-color: var(--status-error);
        }

        .validation-item.warning-severity {
            border-left-color: var(--status-warning);
        }

        .validation-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
        }

        .validation-icon {
            font-size: 14px;
        }

        .validation-name {
            font-size: 12px;
        }

        .severity-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-badge.error {
            background-color: var(--status-error);
            color: white;
        }

        .severity-badge.warning {
            background-color: var(--status-warning);
            color: var(--bg-dark);
        }

        /* ============================================================================
           Main Editor Area
           ============================================================================ */

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; /* Fix for flex children overflow */
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; /* Fix for flex children overflow */
        }

        /* Editor Split View */
        .editor-split {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: 0; /* Fix for flex children overflow */
        }

        .visual-editor {
            flex: 1;
            background-color: var(--bg-dark);
            overflow-y: auto;
            padding: var(--spacing-lg);
            border-right: 1px solid var(--border-main);
            min-height: 0; /* Fix for flex overflow */
        }

        .yaml-editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-dark);
            min-height: 0; /* Fix for flex overflow */
        }

        .yaml-editor-header {
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border-main);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .yaml-editor-header h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .yaml-editor-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0; /* Fix for flex overflow */
        }

        /* Monaco Editor Container */
        #monaco-editor {
            width: 100%;
            height: 100%;
        }

        /* Fallback Textarea (if Monaco fails to load) */
        #yaml-textarea {
            width: 100%;
            height: 100%;
            background-color: var(--bg-input);
            color: var(--text-primary);
            border: none;
            padding: var(--spacing-md);
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        /* ============================================================================
           Help Panel (Right Sidebar)
           ============================================================================ */

        .help-panel {
            width: var(--help-panel-width);
            background-color: var(--bg-sidebar);
            border-left: 1px solid var(--border-main);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .help-panel-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-main);
        }

        .help-panel-header h3 {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .help-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
        }

        .help-section {
            margin-bottom: var(--spacing-lg);
        }

        .help-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--k9-blue);
            margin-bottom: var(--spacing-sm);
        }

        .help-section p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: var(--spacing-sm);
        }

        .help-section ul {
            list-style: none;
            padding-left: 0;
        }

        .help-section li {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 4px 0;
            padding-left: 16px;
            position: relative;
        }

        .help-section li:before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: var(--k9-blue);
        }

        .help-code {
            background-color: var(--bg-input);
            padding: var(--spacing-sm);
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--status-success);
            margin: var(--spacing-sm) 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* ============================================================================
           Bottom Panel
           ============================================================================ */

        .bottom-panel {
            height: 40px;
            min-height: 40px;
            max-height: 40px;
            background-color: var(--bg-panel);
            border-top: 1px solid var(--border-main);
            padding: 0 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .bottom-left {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .bottom-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .footer-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: var(--bg-main);
            border-radius: 3px;
            font-size: 11px;
        }

        .footer-item-label {
            color: var(--text-muted);
        }

        .footer-item-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* ============================================================================
           Buttons
           ============================================================================ */

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-sans);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--k9-blue) 0%, var(--k9-blue-dark) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--k9-blue-hover) 0%, var(--k9-blue) 100%);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-main);
        }

        .btn-secondary:hover {
            background-color: var(--bg-panel-hover);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .btn-danger {
            background-color: var(--status-error);
            color: white;
        }

        .btn-danger:hover {
            background-color: #FF6B56;
            box-shadow: 0 4px 12px rgba(244, 135, 113, 0.4);
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: var(--status-success);
            color: white;
        }

        .btn-success:hover {
            background-color: #5FD9C0;
            box-shadow: 0 4px 12px rgba(78, 201, 176, 0.4);
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 4px 10px;
            font-size: 11px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ============================================================================
           Form Elements
           ============================================================================ */

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .form-label-required:after {
            content: " *";
            color: var(--status-error);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            background-color: var(--bg-input);
            color: var(--text-primary);
            border: 2px solid var(--border-main);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 13px;
            font-family: var(--font-sans);
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
            font-family: var(--font-mono);
            font-size: 12px;
        }

        .form-help {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
            font-style: italic;
        }

        .form-checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .form-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* ============================================================================
           Cards and Panels
           ============================================================================ */

        .card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-main);
            border-radius: 6px;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .card-header {
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-main);
        }

        .card-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-body {
            /* Default styles applied to card content */
        }

        /* ============================================================================
           Modal Dialogs
           ============================================================================ */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-main);
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-main);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background-color: var(--bg-panel-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-lg);
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-main);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* ============================================================================
           Wizard Styles
           ============================================================================ */

        .wizard-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-xl);
            gap: var(--spacing-md);
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .wizard-step.active {
            opacity: 1;
        }

        .wizard-step.completed {
            opacity: 0.7;
        }

        .wizard-step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--bg-input);
            border: 2px solid var(--border-main);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .wizard-step.active .wizard-step-number {
            background-color: var(--k9-blue);
            border-color: var(--k9-blue);
            color: white;
        }

        .wizard-step.completed .wizard-step-number {
            background-color: var(--status-success);
            border-color: var(--status-success);
            color: white;
        }

        .wizard-step-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .wizard-connector {
            width: 40px;
            height: 2px;
            background-color: var(--border-main);
            margin-top: -20px;
        }

        .wizard-step.completed + .wizard-connector {
            background-color: var(--status-success);
        }

        .wizard-content {
            min-height: 300px;
        }

        /* ============================================================================
           Validation Catalog
           ============================================================================ */

        .catalog-search {
            margin-bottom: var(--spacing-md);
        }

        .catalog-categories {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .category-filter {
            padding: 6px 12px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-main);
            border-radius: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-filter:hover,
        .category-filter.active {
            background-color: var(--k9-blue);
            border-color: var(--k9-blue);
            color: white;
        }

        .validation-catalog-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-sm);
        }

        .validation-catalog-item {
            padding: var(--spacing-md);
            background-color: var(--bg-panel);
            border: 1px solid var(--border-main);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .validation-catalog-item:hover {
            border-color: var(--k9-blue);
            background-color: var(--bg-panel-hover);
            transform: translateX(4px);
        }

        .validation-catalog-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
        }

        .validation-catalog-icon {
            font-size: 18px;
        }

        .validation-catalog-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .validation-catalog-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .validation-catalog-category {
            display: inline-block;
            font-size: 10px;
            padding: 2px 8px;
            background-color: var(--bg-input);
            color: var(--text-secondary);
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* ============================================================================
           Welcome Screen
           ============================================================================ */

        .welcome-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: var(--spacing-xl);
        }

        .welcome-content {
            text-align: center;
            max-width: 600px;
        }

        .welcome-logo {
            font-size: 64px;
            margin-bottom: var(--spacing-lg);
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        .welcome-tagline {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
            font-style: italic;
        }

        .welcome-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            margin-top: var(--spacing-xl);
        }

        .welcome-features {
            margin-top: var(--spacing-xl);
            text-align: left;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .welcome-feature {
            padding: var(--spacing-md);
            background-color: var(--bg-panel);
            border: 1px solid var(--border-main);
            border-radius: 6px;
        }

        .welcome-feature h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--k9-blue);
            margin-bottom: var(--spacing-xs);
        }

        .welcome-feature p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ============================================================================
           Tooltips
           ============================================================================ */

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--bg-input);
            color: var(--text-primary);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
            border: 1px solid var(--border-main);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* ============================================================================
           Loading Indicator
           ============================================================================ */

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-main);
            border-top-color: var(--k9-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================================================
           Resizable Panels System
           ============================================================================

           This section implements drag-to-resize functionality for all panels:
           - Resize handles placed between panels
           - Visual feedback on hover and active states
           - Smooth transitions and cursor changes
           - Min/max constraints enforced via JavaScript
        */

        /* Resize handle base styles */
        .resize-handle {
            position: absolute;
            z-index: 100;
            background-color: transparent;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .resize-handle:hover {
            background-color: var(--k9-blue);
            opacity: 0.3;
        }

        .resize-handle.resizing {
            background-color: var(--k9-blue);
            opacity: 0.5;
        }

        /* Vertical resize handles (left-right dragging) */
        .resize-handle-vertical {
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
        }

        /* Horizontal resize handles (up-down dragging) */
        .resize-handle-horizontal {
            left: 0;
            right: 0;
            height: 5px;
            cursor: row-resize;
        }

        /* Sidebar resize handle - positioned on right edge of sidebar */
        .resize-handle-sidebar {
            right: -3px;
        }

        /* Help panel resize handle - positioned on left edge of help panel */
        .resize-handle-help {
            left: -3px;
        }

        /* Bottom panel resize handle - positioned on top edge */
        .resize-handle-bottom {
            top: -3px;
        }

        /* YAML split resize handle - positioned between visual and YAML editors */
        .resize-handle-split {
            width: 5px;
            background-color: var(--border-main);
            cursor: col-resize;
            transition: background-color 0.2s;
            position: relative;
            flex-shrink: 0;
        }

        .resize-handle-split:hover {
            background-color: var(--k9-blue);
        }

        .resize-handle-split.resizing {
            background-color: var(--k9-blue);
        }

        /* ============================================================================
           Collapsible Panels System
           ============================================================================

           Collapse/expand functionality with smooth animations:
           - Collapse buttons in panel headers
           - Smooth width/height transitions
           - Chevron icon rotation animations
           - Collapsed state shows thin bar with expand button
        */

        /* Collapse button styling */
        .collapse-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            line-height: 1;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 3px;
        }

        .collapse-btn:hover {
            background-color: var(--bg-panel-hover);
            color: var(--k9-blue);
        }

        .collapse-btn:focus {
            outline: 2px solid var(--k9-blue);
            outline-offset: 2px;
        }

        /* Chevron icon rotation animation */
        .collapse-icon {
            transition: transform 0.3s ease;
            display: inline-block;
        }

        /* Panel transition animations */
        .sidebar,
        .help-panel,
        .bottom-panel {
            transition: width 0.3s ease, height 0.3s ease, min-width 0.3s ease, min-height 0.3s ease;
            position: relative;
        }

        /* Collapsed states */
        .sidebar.collapsed {
            min-width: 40px !important;
            width: 40px !important;
        }

        .sidebar.collapsed .sidebar-content,
        .sidebar.collapsed .sidebar-header h3,
        .sidebar.collapsed .sidebar-header button {
            display: none;
        }

        .sidebar.collapsed .collapse-icon {
            transform: rotate(180deg);
        }

        .help-panel.collapsed {
            min-width: 40px !important;
            width: 40px !important;
        }

        .help-panel.collapsed .help-panel-content,
        .help-panel.collapsed .help-panel-header h3 {
            display: none;
        }

        .help-panel.collapsed .collapse-icon {
            transform: rotate(180deg);
        }

        .bottom-panel.collapsed {
            display: none;
        }

        /* Collapsed panel bars */
        .collapsed-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-main);
        }

        /* Update panel headers to include collapse button */
        .sidebar-header,
        .help-panel-header {
            position: relative;
        }

        .panel-header-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        /* Bottom panel with collapse button */
        .bottom-panel-header {
            position: absolute;
            top: 0;
            right: 0;
            padding: 4px;
            z-index: 10;
        }

        /* ============================================================================
           Mobile Responsive Design
           ============================================================================

           Comprehensive responsive layouts for mobile, tablet, and desktop:
           - Breakpoints: < 768px (mobile), 768-1024px (tablet), > 1024px (desktop)
           - Mobile: Stacked layout, drawer sidebar, modal help
           - Tablet: Two-column layout, collapsible panels
           - Desktop: Full three-column layout
        */

        /* Mobile hamburger menu */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            padding: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }

        .mobile-menu-btn:hover {
            background-color: var(--bg-panel-hover);
        }

        /* Mobile editor tabs */
        .mobile-editor-tabs {
            display: none;
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border-main);
            flex-shrink: 0; /* Don't let tabs shrink */
        }

        .mobile-tab-buttons {
            display: flex;
            padding: 0;
        }

        .mobile-tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 12px 16px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .mobile-tab-btn:hover {
            background-color: var(--bg-panel-hover);
            color: var(--text-primary);
        }

        .mobile-tab-btn.active {
            color: var(--k9-blue);
            border-bottom-color: var(--k9-blue);
        }

        /* Sidebar drawer overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Tablet (768px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            :root {
                --sidebar-width: 240px;
                --help-panel-width: 280px;
            }

            .help-panel {
                /* Keep help panel but make it collapsible */
            }
        }

        /* Mobile (< 768px) */
        @media (max-width: 768px) {
            /* Show mobile menu button */
            .mobile-menu-btn {
                display: block;
            }

            /* Show mobile editor tabs */
            .mobile-editor-tabs {
                display: block;
            }

            /* Sidebar becomes drawer */
            .sidebar {
                position: fixed;
                top: var(--menu-height);
                left: -100%;
                bottom: 0;
                width: 280px !important;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
            }

            .sidebar.mobile-open {
                left: 0;
                width: 280px !important;
                min-width: 280px !important;
            }

            /* Show sidebar content when mobile drawer is open, even if collapsed on desktop */
            .sidebar.mobile-open .sidebar-content {
                display: block !important;
            }

            .sidebar.mobile-open .sidebar-header {
                display: flex !important;
            }

            .sidebar.mobile-open .sidebar-header h3,
            .sidebar.mobile-open .sidebar-header button {
                display: inline-block !important;
            }

            .sidebar.mobile-open .collapse-icon {
                transform: none !important;
            }

            /* Hide help panel on mobile, show as modal when needed */
            .help-panel {
                position: fixed;
                top: var(--menu-height);
                right: -100%;
                bottom: 0;
                width: 100% !important;
                max-width: 400px;
                z-index: 1000;
                transition: right 0.3s ease;
                box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
            }

            .help-panel.mobile-open {
                right: 0;
                width: 300px !important;
                min-width: 300px !important;
            }

            /* Show help panel content when mobile drawer is open, even if collapsed on desktop */
            .help-panel.mobile-open .help-content {
                display: block !important;
            }

            .help-panel.mobile-open .help-header {
                display: flex !important;
            }

            .help-panel.mobile-open .help-header h3,
            .help-panel.mobile-open .help-header button {
                display: inline-block !important;
            }

            .help-panel.mobile-open .collapse-icon {
                transform: none !important;
            }

            /* Stack editor panels vertically */
            .editor-split {
                flex-direction: column;
            }

            /* Visual and YAML editors toggle visibility */
            .visual-editor,
            .yaml-editor-panel {
                flex: 1 1 100%; /* Allow full flex growth */
                min-height: 0; /* Fix for flex overflow */
                width: 100%;
                display: none;
            }

            .visual-editor.mobile-active {
                display: block;
                overflow-y: auto; /* Ensure scrolling works */
            }

            .yaml-editor-panel.mobile-active {
                display: flex;
                overflow: hidden; /* Monaco editor handles its own scrolling */
            }

            /* Bottom panel always collapsed on mobile */
            .bottom-panel {
                min-height: 35px !important;
                height: 35px !important;
            }

            .bottom-panel .bottom-left,
            .bottom-panel .bottom-right {
                display: none;
            }

            .bottom-panel.mobile-expanded {
                min-height: auto !important;
                height: auto !important;
            }

            .bottom-panel.mobile-expanded .bottom-left,
            .bottom-panel.mobile-expanded .bottom-right {
                display: flex;
            }

            /* Welcome screen features stack */
            .welcome-features {
                grid-template-columns: 1fr;
            }

            /* Touch-friendly sizing */
            .btn {
                min-height: 44px;
                padding: 12px 16px;
            }

            .file-header,
            .validation-item {
                min-height: 44px;
            }

            /* Hide resize handles on mobile */
            .resize-handle {
                display: none;
            }
        }

        /* Responsive Adjustments (keeping original for compatibility) */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 240px;
                --help-panel-width: 280px;
            }
        }

        /* ============================================================================
           Utility Classes
           ============================================================================ */

        .hidden {
            display: none !important;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .text-error {
            color: var(--status-error);
        }

        .text-success {
            color: var(--status-success);
        }

        .text-warning {
            color: var(--status-warning);
        }

        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: var(--spacing-xs); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mb-4 { margin-bottom: var(--spacing-lg); }

        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: var(--spacing-xs); }
        .mt-2 { margin-top: var(--spacing-sm); }
        .mt-3 { margin-top: var(--spacing-md); }
        .mt-4 { margin-top: var(--spacing-lg); }

        /* ============================================================================
           Drag and Drop Styles
           ============================================================================

           These styles support drag and drop reordering for both validation items
           and file items within the project tree. Visual feedback includes:
           - Drag handles with cursor changes
           - Opacity changes during drag
           - Border indicators for drop zones
           - Smooth transitions for all state changes
        */

        .validation-drag-handle,
        .file-drag-handle {
            cursor: grab;
            color: var(--text-secondary);
            padding: 4px 8px;
            font-size: 14px;
            user-select: none;
            display: inline-flex;
            align-items: center;
            transition: color 0.2s;
        }

        .validation-drag-handle:hover,
        .file-drag-handle:hover {
            color: var(--k9-blue);
        }

        .validation-drag-handle:active,
        .file-drag-handle:active {
            cursor: grabbing;
        }

        /* Validation item transitions for smooth drag interactions */
        .validation-item {
            transition: all 0.2s ease;
            position: relative;
        }

        /* Visual feedback during drag operation */
        .validation-item.dragging,
        .file-item.dragging {
            opacity: 0.5;
            background-color: var(--bg-panel-hover);
        }

        /* Drop zone indicators - show where item will be dropped */
        .validation-item.drag-over-top {
            border-top: 2px solid var(--k9-blue);
            margin-top: 2px;
        }

        .validation-item.drag-over-bottom {
            border-bottom: 2px solid var(--k9-blue);
            margin-bottom: 2px;
        }

        .file-item.drag-over-top {
            border-top: 2px solid var(--k9-blue);
            margin-top: 2px;
        }

        .file-item.drag-over-bottom {
            border-bottom: 2px solid var(--k9-blue);
            margin-bottom: 2px;
        }

        /* Animation for newly duplicated validations - pulse effect */
        .validation-item.just-duplicated {
            animation: duplicatePulse 0.6s ease;
        }

        @keyframes duplicatePulse {
            0%, 100% {
                background-color: transparent;
            }
            50% {
                background-color: rgba(74, 144, 226, 0.2);
            }
        }

        /* ============================================================================
           Context Menu Styles
           ============================================================================

           Right-click context menu for validation items providing quick access to:
           - Move up/down actions
           - Duplicate validation
           - Edit validation
           - Delete validation
        */

        .context-menu {
            position: fixed;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-main);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            min-width: 180px;
            padding: 4px 0;
            animation: contextMenuFadeIn 0.15s ease;
        }

        @keyframes contextMenuFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 13px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: var(--bg-panel-hover);
        }

        .context-menu-item.danger {
            color: var(--status-error);
        }

        .context-menu-item.disabled {
            color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .context-menu-item.disabled:hover {
            background-color: transparent;
        }

        .context-menu-divider {
            height: 1px;
            background-color: var(--border-main);
            margin: 4px 0;
        }

        /* ============================================================================
           Touch Support for Mobile
           ============================================================================

           Enhanced touch targets and feedback for mobile drag operations
        */

        @media (max-width: 768px) {
            /* Larger touch targets for mobile */
            .validation-drag-handle,
            .file-drag-handle {
                padding: 12px;
                font-size: 18px;
            }

            /* Ensure duplicate button is large enough for touch */
            .file-action-btn {
                padding: 8px;
                font-size: 14px;
            }
        }

        /* ============================================================================
           Additional Action Button Styles
           ============================================================================

           Styles for the duplicate button and other validation item actions
        */

        .validation-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .validation-item:hover .validation-actions {
            opacity: 1;
        }

        .validation-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s, color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .validation-action-btn:hover {
            opacity: 1;
            color: var(--text-primary);
        }

        .validation-action-btn.duplicate-btn:hover {
            color: var(--k9-blue);
        }

        .validation-action-btn.delete-btn:hover {
            color: var(--status-error);
        }
    </style>
</head>
<body>
    <!-- ============================================================================
         Application Container
         ============================================================================ -->
    <div class="app-container">

        <!-- Menu Bar -->
        <div class="menu-bar">
            <!-- Mobile hamburger menu button - hidden on desktop -->
            <button class="mobile-menu-btn" onclick="panelManager.toggleMobileSidebar()"
                    aria-label="Toggle sidebar" title="Toggle sidebar">
                â˜°
            </button>

            <!-- Phase 5: Full dropdown menus -->
            <div class="menu-item" id="file-menu" onclick="app.toggleMenu('file')">
                File
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); app.startNewProject()">
                        <span>New Project</span>
                        <span class="shortcut">Ctrl+N</span>
                    </div>
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); app.openProjectDialog()">
                        <span>Open Project...</span>
                        <span class="shortcut">Ctrl+O</span>
                    </div>
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); app.closeProject()">
                        <span>Close Project</span>
                    </div>
                    <div class="menu-dropdown-item separator"></div>
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); app.openExportDocsDialog()">
                        <span>Export Documentation...</span>
                    </div>
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); app.exportYAML()">
                        <span>Export YAML (Project)</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" id="edit-menu" onclick="app.toggleMenu('edit')">
                Edit
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item disabled">
                        <span>Undo</span>
                        <span class="shortcut">Ctrl+Z</span>
                    </div>
                    <div class="menu-dropdown-item disabled">
                        <span>Redo</span>
                        <span class="shortcut">Ctrl+Y</span>
                    </div>
                    <div class="menu-dropdown-item separator"></div>
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); app.addFile()">
                        <span>Add File...</span>
                    </div>
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); if(app.selectedFile !== null) app.addValidationToFile(app.selectedFile); else alert('Please select a file first');">
                        <span>Add Validation...</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" id="view-menu" onclick="app.toggleMenu('view')">
                View
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); panelManager.togglePanel('sidebar')">
                        <span>Toggle Sidebar</span>
                        <span class="shortcut">Ctrl+B</span>
                    </div>
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); panelManager.togglePanel('bottom-panel')">
                        <span>Toggle Footer</span>
                        <span class="shortcut">Ctrl+J</span>
                    </div>
                </div>
            </div>

            <div class="menu-item" id="help-menu" onclick="app.toggleMenu('help')">
                Help
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); app.openCatalog()">
                        <span>Validation Catalog</span>
                    </div>
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); app.showKeyboardShortcuts()">
                        <span>Keyboard Shortcuts</span>
                    </div>
                    <div class="menu-dropdown-item separator"></div>
                    <div class="menu-dropdown-item" onclick="event.stopPropagation(); app.closeAllMenus(); app.showAbout()">
                        <span>About</span>
                    </div>
                </div>
            </div>
            <div class="app-title">
                <span class="logo">ðŸ•</span>
                <span>DataK9 Studio - Your IDE for Data Quality</span>
            </div>
        </div>

        <!-- App Body -->
        <div class="app-body">

            <!-- Left Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="panel-header-title">
                        <h3>Configuration</h3>
                        <button class="collapse-btn" onclick="panelManager.togglePanel('sidebar')"
                                aria-label="Collapse sidebar (Ctrl+B)" title="Collapse sidebar (Ctrl+B)">
                            <span class="collapse-icon">â—€</span>
                        </button>
                    </div>
                </div>
                <div class="sidebar-content" id="file-tree">
                    <!-- Configuration navigation will be rendered here -->
                </div>
                <!-- Resize handle for sidebar -->
                <div class="resize-handle resize-handle-vertical resize-handle-sidebar"
                     data-panel="sidebar"
                     aria-label="Resize sidebar"></div>
            </div>

            <!-- Main Editor Area -->
            <div class="main-area">
                <div class="editor-container">

                    <!-- Welcome Screen (shown when no project) -->
                    <div id="welcome-screen" class="welcome-screen">
                        <div class="welcome-content">
                            <div class="welcome-logo">ðŸ•</div>
                            <h1 class="welcome-title">DataK9 Studio</h1>
                            <p class="welcome-tagline">Your IDE for Data Quality</p>
                            <div class="welcome-actions">
                                <button class="btn btn-primary" onclick="app.startNewProject()">
                                    ðŸš€ New Project
                                </button>
                                <button class="btn btn-secondary" onclick="app.openProjectDialog()">
                                    ðŸ“‚ Open Project
                                </button>
                                <button class="btn btn-secondary" onclick="app.openCatalog()">
                                    ðŸ“š Browse Validations
                                </button>
                            </div>
                            <div class="welcome-features">
                                <div class="welcome-feature">
                                    <h4>ðŸŽ¨ Visual Builder</h4>
                                    <p>Build validation rules with an intuitive visual interface</p>
                                </div>
                                <div class="welcome-feature">
                                    <h4>ðŸ’» YAML Editor</h4>
                                    <p>Edit configurations directly with syntax highlighting</p>
                                </div>
                                <div class="welcome-feature">
                                    <h4>ðŸ”„ Two-Way Sync</h4>
                                    <p>Changes sync automatically between UI and YAML</p>
                                </div>
                                <div class="welcome-feature">
                                    <h4>ðŸ“¦ 30+ Validation Types</h4>
                                    <p>Comprehensive library of production-tested validators</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Editor Tabs - shown only on mobile -->
                    <div class="mobile-editor-tabs" id="mobile-editor-tabs">
                        <div class="mobile-tab-buttons">
                            <button class="mobile-tab-btn active" data-tab="visual"
                                    onclick="panelManager.switchMobileTab('visual')">
                                Visual
                            </button>
                            <button class="mobile-tab-btn" data-tab="yaml"
                                    onclick="panelManager.switchMobileTab('yaml')">
                                YAML
                            </button>
                        </div>
                    </div>

                    <!-- Editor Split View (hidden initially) -->
                    <div id="editor-view" class="editor-split hidden">

                        <!-- Visual Editor -->
                        <div class="visual-editor mobile-active" id="visual-editor">
                            <!-- Visual configuration builder will be rendered here -->
                        </div>

                        <!-- Resize handle for split view -->
                        <div class="resize-handle-split" id="split-resize-handle"
                             aria-label="Resize editor split"></div>

                        <!-- YAML Editor -->
                        <div class="yaml-editor-panel" id="yaml-editor-panel">
                            <div class="yaml-editor-header">
                                <h3>YAML Configuration</h3>
                                <div style="display: flex; gap: 8px;">
                                    <button id="yaml-lock-btn" class="btn btn-small btn-secondary" onclick="app.toggleYAMLLock()" title="Unlock to edit YAML directly">
                                        ðŸ”’ Unlock to Edit
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="app.copyYAML()">
                                        ðŸ“‹ Copy
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="app.formatYAML()">
                                        âœ¨ Format
                                    </button>
                                </div>
                            </div>
                            <div class="yaml-editor-content">
                                <!-- Monaco Editor will be initialized here -->
                                <div id="monaco-editor"></div>
                                <!-- Fallback textarea if Monaco doesn't load -->
                                <textarea id="yaml-textarea" class="hidden"></textarea>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

            <!-- Right Help Panel -->
            <div class="help-panel" id="help-panel">
                <!-- Resize handle for help panel -->
                <div class="resize-handle resize-handle-vertical resize-handle-help"
                     data-panel="help-panel"
                     aria-label="Resize help panel"></div>

                <div class="help-panel-header">
                    <div class="panel-header-title">
                        <h3>Help & Documentation</h3>
                        <button class="collapse-btn" onclick="panelManager.togglePanel('help-panel')"
                                aria-label="Collapse help panel (Ctrl+H)" title="Collapse help panel (Ctrl+H)">
                            <span class="collapse-icon">â–¶</span>
                        </button>
                    </div>
                </div>
                <div class="help-panel-content" id="help-content">
                    <div class="help-section">
                        <h4>Welcome to DataK9 Studio</h4>
                        <p>Your professional IDE for building data validation configurations.</p>
                        <p>Start by creating a new project or importing an existing YAML configuration.</p>
                    </div>
                    <div class="help-section">
                        <h4>Quick Tips</h4>
                        <ul>
                            <li>Use ERROR severity for critical data requirements</li>
                            <li>Use WARNING severity for data quality issues</li>
                            <li>All validations support conditional execution</li>
                            <li>Changes are auto-saved to localStorage</li>
                        </ul>
                    </div>
                    <div class="help-section">
                        <h4>Keyboard Shortcuts</h4>
                        <ul>
                            <li>Ctrl+S - Export YAML (Project)</li>
                            <li>Ctrl+R - Sync from YAML</li>
                            <li>Ctrl+N - New project</li>
                            <li>Ctrl+O - Open project</li>
                            <li>Ctrl+B - Toggle sidebar</li>
                            <li>Ctrl+H - Toggle help panel</li>
                            <li>Ctrl+J - Toggle footer</li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer (Fixed Height) -->
        <div class="bottom-panel" id="bottom-panel">
            <div class="bottom-left">
                <div class="footer-item" id="project-status">
                    <span class="footer-item-label">Project:</span>
                    <span class="footer-item-value">No project</span>
                </div>
                <div class="footer-item" id="files-count">
                    <span class="footer-item-label">Files:</span>
                    <span class="footer-item-value">0</span>
                </div>
                <div class="footer-item" id="validations-count">
                    <span class="footer-item-label">Validations:</span>
                    <span class="footer-item-value">0</span>
                </div>
            </div>
            <div class="bottom-right">
                <button class="btn btn-secondary btn-small" onclick="app.openExportDocsDialog()">
                    ðŸ“„ Export Docs
                </button>
                <button class="btn btn-success btn-small" onclick="app.exportYAML()">
                    ðŸ’¾ Export YAML (Project)
                </button>
            </div>
        </div>

        <!-- Sidebar overlay for mobile (tap to close) -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="panelManager.closeMobilePanels()"></div>

    </div>

    <!-- ============================================================================
         Modal Dialogs
         ============================================================================ -->

    <!-- New Project Wizard Modal -->
    <div id="new-project-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>New Validation Project</h2>
                <button class="modal-close" onclick="app.closeModal('new-project-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Wizard steps indicator -->
                <div class="wizard-steps">
                    <div class="wizard-step active" data-step="1">
                        <div class="wizard-step-number">1</div>
                        <div class="wizard-step-label">Project Info</div>
                    </div>
                    <div class="wizard-connector"></div>
                    <div class="wizard-step" data-step="2">
                        <div class="wizard-step-number">2</div>
                        <div class="wizard-step-label">Settings</div>
                    </div>
                    <div class="wizard-connector"></div>
                    <div class="wizard-step" data-step="3">
                        <div class="wizard-step-number">3</div>
                        <div class="wizard-step-label">First File</div>
                    </div>
                </div>

                <!-- Wizard content -->
                <div class="wizard-content">
                    <!-- Step 1: Project Info -->
                    <div id="wizard-step-1" class="wizard-step-content">
                        <div class="form-group">
                            <label class="form-label form-label-required">Project Name</label>
                            <input type="text" class="form-input" id="wizard-project-name"
                                   placeholder="My Data Validation Project">
                            <div class="form-help">A descriptive name for your validation project</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" id="wizard-project-description"
                                      placeholder="Optional description of what this validation project does"></textarea>
                        </div>
                    </div>

                    <!-- Step 2: Settings -->
                    <div id="wizard-step-2" class="wizard-step-content hidden">
                        <div class="form-group">
                            <label class="form-label">Chunk Size</label>
                            <input type="number" class="form-input" id="wizard-chunk-size" value="50000">
                            <div class="form-help">Number of rows to process at once (default: 50000)</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max Sample Failures</label>
                            <input type="number" class="form-input" id="wizard-max-failures" value="100">
                            <div class="form-help">Maximum failures to collect before stopping (default: 100)</div>
                        </div>
                        <div class="form-group">
                            <div class="form-checkbox-group">
                                <input type="checkbox" class="form-checkbox" id="wizard-fail-error" checked>
                                <label class="form-label mb-0">Fail on ERROR severity</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-checkbox-group">
                                <input type="checkbox" class="form-checkbox" id="wizard-fail-warning">
                                <label class="form-label mb-0">Fail on WARNING severity</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Log Level</label>
                            <select class="form-select" id="wizard-log-level">
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO" selected>INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                        </div>
                    </div>

                    <!-- Step 3: First File -->
                    <div id="wizard-step-3" class="wizard-step-content hidden">
                        <div class="form-group">
                            <label class="form-label form-label-required">File Name</label>
                            <input type="text" class="form-input" id="wizard-file-name"
                                   placeholder="customer_data">
                            <div class="form-help">A logical name for this file (e.g., "customer_data")</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-label-required">File Path</label>
                            <input type="text" class="form-input" id="wizard-file-path"
                                   placeholder="data/customers.csv">
                            <div class="form-help">Path to the file to validate</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label form-label-required">File Format</label>
                            <select class="form-select" id="wizard-file-format" onchange="app.updateWizardRecommendations()">
                                <option value="csv">CSV</option>
                                <option value="excel">Excel</option>
                                <option value="json">JSON</option>
                                <option value="parquet">Parquet</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">File Size (MB)</label>
                            <input type="number" class="form-input" id="wizard-file-size"
                                   placeholder="100" min="0" step="0.1"
                                   oninput="app.updateWizardRecommendations()">
                            <div class="form-help">Optional: Estimated file size for performance recommendations</div>
                        </div>

                        <!-- Recommendations Display -->
                        <div id="wizard-recommendations" style="display: none; margin-top: 20px; padding: 16px; border-radius: 8px; background: var(--bg-panel); border: 1px solid var(--border-color);">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="wizard-back-btn" onclick="app.wizardBack()" style="display: none;">
                    â† Back
                </button>
                <button class="btn btn-primary" id="wizard-next-btn" onclick="app.wizardNext()">
                    Next â†’
                </button>
                <button class="btn btn-success" id="wizard-finish-btn" onclick="app.wizardFinish()" style="display: none;">
                    âœ“ Create Project
                </button>
            </div>
        </div>
    </div>

    <!-- Open Project Modal (Unified) -->
    <div id="open-project-modal" class="modal-overlay">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2>ðŸ“‚ Open Project</h2>
                <button class="modal-close" onclick="app.closeModal('open-project-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 24px; color: var(--text-secondary);">
                    Choose how you want to open your YAML configuration:
                </p>

                <!-- Open Method Tabs -->
                <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid var(--border-color);">
                    <button id="open-from-file-tab" class="tab-button active" onclick="app.switchOpenMethod('file')"
                            style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid var(--k9-blue); color: var(--k9-blue); font-weight: 600; cursor: pointer;">
                        ðŸ“‚ Open from File
                    </button>
                    <button id="open-from-paste-tab" class="tab-button" onclick="app.switchOpenMethod('paste')"
                            style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer;">
                        ðŸ“‹ Paste YAML
                    </button>
                </div>

                <!-- Open from File Section -->
                <div id="open-from-file-section" class="open-method-section">
                    <div style="text-align: center; padding: 40px; border: 2px dashed var(--border-color); border-radius: 8px; background: var(--bg-panel);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“„</div>
                        <h4 style="margin-bottom: 12px;">Select a YAML file to open</h4>
                        <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 13px;">
                            Choose a .yaml or .yml configuration file from your computer
                        </p>
                        <input type="file" id="open-file-input" accept=".yaml,.yml" style="display: none;" onchange="app.handleFileSelect(event)">
                        <button class="btn btn-primary" onclick="document.getElementById('open-file-input').click()">
                            ðŸ“‚ Choose File...
                        </button>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: var(--bg-main); border-radius: 4px; border-left: 3px solid var(--k9-blue);">
                        <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                            <strong>Tip:</strong> You can also drag and drop a YAML file directly onto the Studio window
                        </p>
                    </div>
                </div>

                <!-- Paste YAML Section -->
                <div id="open-from-paste-section" class="open-method-section" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Paste your YAML configuration below:</label>
                        <textarea class="form-textarea" id="import-yaml-text"
                                  placeholder="validation_job:
  name: 'My Validation'
  description: 'Description here'

processing:
  chunk_size: 50000
  max_sample_failures: 100

files:
  - name: 'file1'
    path: 'data/file.csv'
    format: 'csv'
    validations: []" style="min-height: 300px; font-family: 'Courier New', monospace; font-size: 13px;"></textarea>
                        <div class="form-help">Paste a complete YAML configuration or copy from an existing project</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('open-project-modal')">Cancel</button>
                <button id="open-project-action-btn" class="btn btn-primary" onclick="app.openProjectFromFile()">
                    Open from File
                </button>
            </div>
        </div>
    </div>

    <!-- Validation Catalog Modal -->
    <div id="catalog-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Validation Catalog</h2>
                <button class="modal-close" onclick="app.closeModal('catalog-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="catalog-search">
                    <input type="text" class="form-input" id="catalog-search"
                           placeholder="Search validations..."
                           oninput="app.filterCatalog()">
                </div>
                <div class="catalog-categories" id="catalog-categories">
                    <!-- Category filters will be rendered here -->
                </div>
                <div class="validation-catalog-list" id="catalog-list">
                    <!-- Validation catalog items will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('catalog-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Validation Modal -->
    <div id="add-validation-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Add Validation</h2>
                <button class="modal-close" onclick="app.closeModal('add-validation-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="catalog-search">
                    <input type="text" class="form-input" id="add-validation-search"
                           placeholder="Search validations..."
                           oninput="app.filterAddValidation()">
                </div>
                <div class="catalog-categories" id="add-validation-categories">
                    <!-- Category filters will be rendered here -->
                </div>
                <div class="validation-catalog-list" id="add-validation-list">
                    <!-- Validation catalog items will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('add-validation-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Validation Modal -->
    <div id="edit-validation-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="edit-validation-title">Edit Validation</h2>
                <button class="modal-close" onclick="app.closeModal('edit-validation-modal')">&times;</button>
            </div>
            <div class="modal-body" id="edit-validation-content">
                <!-- Validation form will be rendered here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="app.deleteCurrentValidation()">Delete</button>
                <button class="btn btn-secondary" onclick="app.closeModal('edit-validation-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveCurrentValidation()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add File Modal -->
    <div id="add-file-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Add File</h2>
                <button class="modal-close" onclick="app.closeModal('add-file-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label form-label-required">File Name</label>
                    <input type="text" class="form-input" id="add-file-name" placeholder="customer_data">
                    <div class="form-help">Logical name for this file</div>
                </div>
                <div class="form-group">
                    <label class="form-label form-label-required">File Path</label>
                    <input type="text" class="form-input" id="add-file-path" placeholder="data/customers.csv">
                    <div class="form-help">Path to the file to validate</div>
                </div>
                <div class="form-group">
                    <label class="form-label form-label-required">File Format</label>
                    <select class="form-select" id="add-file-format" onchange="app.updateFileRecommendations()">
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                        <option value="json">JSON</option>
                        <option value="parquet">Parquet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Estimated File Size (MB)</label>
                    <input type="number" class="form-input" id="add-file-size" placeholder="100" min="0" step="1" oninput="app.updateFileRecommendations()">
                    <div class="form-help">Optional: Helps calculate optimal chunk size and show format recommendations</div>
                </div>
                <div id="file-recommendations" style="display: none; margin-top: 16px; padding: 12px; background: var(--bg-panel); border-left: 3px solid var(--status-warning); border-radius: 4px;">
                    <!-- Recommendations will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('add-file-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveNewFile()">Add File</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>About DataK9 Studio</h2>
                <button class="modal-close" onclick="app.closeModal('about-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 96px; margin-bottom: 16px;">ðŸ•</div>
                    <h3 style="font-size: 24px; margin-bottom: 8px;">DataK9 Studio</h3>
                    <p style="color: var(--text-secondary); font-style: italic;">Your IDE for Data Quality</p>
                    <p style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">Version 1.0.0</p>
                </div>
                <div class="help-section">
                    <h4>What is DataK9 Studio?</h4>
                    <p>DataK9 Studio is a professional IDE-style interface for creating and managing data quality validation configurations.</p>
                </div>
                <div class="help-section">
                    <h4>Features</h4>
                    <ul>
                        <li>36 validation types across 10 categories</li>
                        <li>Visual configuration builder</li>
                        <li>Live YAML editor with syntax highlighting</li>
                        <li>Two-way sync between UI and YAML</li>
                        <li>Export documentation (HTML/Markdown)</li>
                        <li>Project state management</li>
                        <li>Validation reordering</li>
                        <li>Auto-save to localStorage</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="app.closeModal('about-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Export Documentation Modal (Phase 2) -->
    <div id="export-docs-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2>ðŸ“„ Export Documentation</h2>
                <button class="modal-close" onclick="app.closeModal('export-docs-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="export-format">Format:</label>
                    <select id="export-format" class="form-control">
                        <option value="html">HTML (Interactive)</option>
                        <option value="markdown">Markdown (Text)</option>
                    </select>
                    <p class="help-text">Choose the output format for your documentation</p>
                </div>

                <div class="form-group" id="theme-selector">
                    <label for="export-theme">Theme:</label>
                    <select id="export-theme" class="form-control">
                        <option value="dark">Dark Theme</option>
                        <option value="light">Light Theme</option>
                    </select>
                    <p class="help-text">Color scheme for HTML documentation</p>
                </div>

                <div class="form-group">
                    <label>Include Sections:</label>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-project-info" checked>
                            <span>Project Information</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-files" checked>
                            <span>File List</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-validations" checked>
                            <span>Validation Summary</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-params" checked>
                            <span>Parameter Details</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="include-examples" checked>
                            <span>Examples & Tips</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('export-docs-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.generateDocumentation()">
                    ðŸ“„ Generate Documentation
                </button>
            </div>
        </div>
    </div>

    <!-- YAML Error Modal -->
    <div id="yaml-error-modal" class="modal-overlay">
        <div class="modal">
            <div id="yaml-error-content">
                <!-- Error content will be dynamically inserted here -->
            </div>
        </div>
    </div>


    <!-- ============================================================================
         Monaco Editor (Self-Hosted for Corporate Environments)
         ============================================================================ -->
    <script src="monaco-editor/min/vs/loader.js"></script>

    <!-- ============================================================================
         Application JavaScript
         ============================================================================ -->
    <script>
        /* ========================================================================
           DataK9 Studio Application
           ========================================================================

           This application manages the entire IDE experience including:
           - Project state management
           - Visual configuration builder
           - YAML editor integration
           - Two-way sync between UI and YAML
           - Validation catalog
           - Import/Export functionality
           - localStorage persistence
        */

        // Application state object
        const app = {
            /* ====================================================================
               Security Utilities (Phase 1 - Security Fixes)
               ==================================================================== */

            /**
             * Escapes HTML special characters to prevent XSS attacks
             * @param {string} unsafe - Unescaped user input
             * @returns {string} - HTML-safe string
             */
            escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') return unsafe;
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            },

            /**
             * Validates config structure before loading
             * @param {object} config - Config object to validate
             * @returns {boolean} - True if valid structure
             */
            validateConfigStructure(config) {
                if (!config || typeof config !== 'object') return false;
                if (!config.validation_job || typeof config.validation_job !== 'object') return false;
                if (!Array.isArray(config.files)) return false;
                if (!config.settings || typeof config.settings !== 'object') return false;

                // Validate settings have required fields
                const requiredSettings = ['chunk_size', 'max_sample_failures', 'log_level'];
                for (const field of requiredSettings) {
                    if (!(field in config.settings)) return false;
                }

                return true;
            },

            /**
             * Deep sanitizes all string values in config to prevent XSS
             * @param {object} config - Config object to sanitize
             * @returns {object} - Sanitized config
             */
            sanitizeConfig(config) {
                return JSON.parse(JSON.stringify(config, (key, value) => {
                    if (typeof value === 'string') {
                        return this.escapeHtml(value);
                    }
                    return value;
                }));
            },

            /* ====================================================================
               Application State
               ==================================================================== */

            // Current project configuration
            config: {
                validation_job: {
                    name: '',
                    description: ''
                },
                settings: {
                    chunk_size: 50000,
                    max_sample_failures: 100,
                    fail_on_error: true,
                    fail_on_warning: false,
                    log_level: 'INFO'
                },
                files: []
            },

            // Currently selected file and validation
            selectedFile: null,
            selectedValidation: null,

            // Monaco editor instance
            monacoEditor: null,

            // Wizard state
            wizardStep: 1,

            // Flag to prevent circular updates during sync
            isSyncing: false,

            // Sync token for race condition prevention
            syncToken: 0,

            // Project state management (Phase 3)
            projectState: {
                isOpen: false,                  // Whether a project is currently open
                hasExportedYAML: false,         // Whether project has been exported at least once
                lastExported: null,             // Timestamp of last YAML export
                lastModified: null,             // Timestamp of last modification
                projectFileName: null           // Filename from opened/exported file
            },

            // UI state
            projectSettingsExpanded: false,  // Whether project settings panel is expanded

            /* ====================================================================
               Validation Library - Loaded Dynamically from JSON
               ====================================================================

               This library is now loaded from validation_definitions.json at startup.
               This ensures the Studio stays in sync with the framework's validation types.

               Fallback definitions are maintained below for offline/error scenarios.
            */
            validationLibrary: {},  // Will be populated from JSON

            // Fallback hardcoded validations (used if JSON load fails)
            fallbackValidationLibrary: {
                // File-Level Validations
                'EmptyFileCheck': {
                    icon: 'ðŸ“„',
                    name: 'Empty File Check',
                    type: 'EmptyFileCheck',
                    category: 'File-Level',
                    description: 'Validates that the file is not empty and optionally contains data rows',
                    params: [
                        {
                            name: 'check_data_rows',
                            label: 'Check Data Rows',
                            type: 'checkbox',
                            required: false,
                            help: 'If true, checks for actual data rows (not just headers)'
                        }
                    ],
                    examples: 'Ensure input files are not empty before processing',
                    tips: 'Use ERROR severity to prevent processing empty files'
                },

                'RowCountRangeCheck': {
                    icon: 'ðŸ“Š',
                    name: 'Row Count Range Check',
                    type: 'RowCountRangeCheck',
                    category: 'File-Level',
                    description: 'Validates that the number of rows falls within specified bounds',
                    params: [
                        {
                            name: 'min_rows',
                            label: 'Minimum Rows',
                            type: 'number',
                            required: false,
                            help: 'Minimum acceptable number of rows'
                        },
                        {
                            name: 'max_rows',
                            label: 'Maximum Rows',
                            type: 'number',
                            required: false,
                            help: 'Maximum acceptable number of rows'
                        }
                    ],
                    examples: 'Validate daily extract contains expected volume (e.g., min_rows: 1000)',
                    tips: 'Set realistic bounds based on historical data patterns'
                },

                'FileSizeCheck': {
                    icon: 'ðŸ’¾',
                    name: 'File Size Check',
                    type: 'FileSizeCheck',
                    category: 'File-Level',
                    description: 'Validates file size is within acceptable limits',
                    params: [
                        {
                            name: 'min_size_mb',
                            label: 'Min Size (MB)',
                            type: 'number',
                            required: false,
                            help: 'Minimum file size in megabytes'
                        },
                        {
                            name: 'max_size_mb',
                            label: 'Max Size (MB)',
                            type: 'number',
                            required: false,
                            help: 'Maximum file size in megabytes'
                        },
                        {
                            name: 'max_size_gb',
                            label: 'Max Size (GB)',
                            type: 'number',
                            required: false,
                            help: 'Maximum file size in gigabytes'
                        }
                    ],
                    examples: 'Prevent processing of unexpectedly large files',
                    tips: 'Use to catch corrupt or malformed files early'
                },

                // Schema Validations
                'SchemaMatchCheck': {
                    icon: 'ðŸŽ¨',
                    name: 'Schema Match Check',
                    type: 'SchemaMatchCheck',
                    category: 'Schema',
                    description: 'Validates columns and their data types match expected schema',
                    params: [
                        {
                            name: 'expected_columns',
                            label: 'Expected Columns (comma-separated)',
                            type: 'text',
                            required: true,
                            help: 'List of expected column names'
                        },
                        {
                            name: 'allow_extra',
                            label: 'Allow Extra Columns',
                            type: 'checkbox',
                            required: false,
                            help: 'Permit additional columns not in expected list'
                        },
                        {
                            name: 'allow_missing',
                            label: 'Allow Missing Columns',
                            type: 'checkbox',
                            required: false,
                            help: 'Permit missing columns from expected list'
                        }
                    ],
                    examples: 'Enforce strict schema: expected_columns: [id, name, email]',
                    tips: 'Use strict matching (both false) for critical interfaces'
                },

                'ColumnPresenceCheck': {
                    icon: 'ðŸ“‹',
                    name: 'Column Presence Check',
                    type: 'ColumnPresenceCheck',
                    category: 'Schema',
                    description: 'Checks that required columns exist in the file',
                    params: [
                        {
                            name: 'required_columns',
                            label: 'Required Columns (comma-separated)',
                            type: 'text',
                            required: true,
                            help: 'Columns that must be present'
                        },
                        {
                            name: 'case_sensitive',
                            label: 'Case Sensitive',
                            type: 'checkbox',
                            required: false,
                            help: 'Whether column name matching is case-sensitive'
                        }
                    ],
                    examples: 'Ensure critical columns exist: required_columns: [customer_id, order_date]',
                    tips: 'Lighter weight than SchemaMatchCheck when you only care about presence'
                },

                // Field-Level Validations
                'MandatoryFieldCheck': {
                    icon: 'ðŸ“',
                    name: 'Mandatory Field Check',
                    type: 'MandatoryFieldCheck',
                    category: 'Field-Level',
                    description: 'Validates that specified fields are not null or empty',
                    params: [
                        {
                            name: 'fields',
                            label: 'Fields (comma-separated)',
                            type: 'text',
                            required: true,
                            help: 'Fields that cannot be null or empty'
                        }
                    ],
                    examples: 'Ensure primary keys are populated: fields: [customer_id, order_id]',
                    tips: 'Use for critical fields that must always have values'
                },

                'RegexCheck': {
                    icon: 'ðŸ”¤',
                    name: 'Regex Pattern Check',
                    type: 'RegexCheck',
                    category: 'Field-Level',
                    description: 'Validates field values match a regular expression pattern',
                    params: [
                        {
                            name: 'field',
                            label: 'Field Name',
                            type: 'text',
                            required: true,
                            help: 'Field to validate'
                        },
                        {
                            name: 'pattern',
                            label: 'Regex Pattern',
                            type: 'text',
                            required: true,
                            help: 'Regular expression pattern to match'
                        },
                        {
                            name: 'message',
                            label: 'Error Message',
                            type: 'text',
                            required: false,
                            help: 'Custom error message for failures'
                        },
                        {
                            name: 'invert',
                            label: 'Invert Match',
                            type: 'checkbox',
                            required: false,
                            help: 'Fail if pattern DOES match (instead of does not match)'
                        }
                    ],
                    examples: 'Email: ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$',
                    tips: 'Test patterns thoroughly - use online regex testers'
                },

                'ValidValuesCheck': {
                    icon: 'ðŸŽ¯',
                    name: 'Valid Values Check',
                    type: 'ValidValuesCheck',
                    category: 'Field-Level',
                    description: 'Validates field values are in an allowed list',
                    params: [
                        {
                            name: 'field',
                            label: 'Field Name',
                            type: 'text',
                            required: true,
                            help: 'Field to validate'
                        },
                        {
                            name: 'valid_values',
                            label: 'Valid Values (comma-separated)',
                            type: 'text',
                            required: true,
                            help: 'List of acceptable values'
                        }
                    ],
                    examples: 'Status field: valid_values: [active, inactive, pending]',
                    tips: 'Great for categorical fields with fixed options'
                },

                'RangeCheck': {
                    icon: 'ðŸ“',
                    name: 'Range Check',
                    type: 'RangeCheck',
                    category: 'Field-Level',
                    description: 'Validates numeric values fall within a specified range',
                    params: [
                        {
                            name: 'field',
                            label: 'Field Name',
                            type: 'text',
                            required: true,
                            help: 'Numeric field to validate'
                        },
                        {
                            name: 'min_value',
                            label: 'Minimum Value',
                            type: 'number',
                            required: false,
                            help: 'Minimum acceptable value (inclusive)'
                        },
                        {
                            name: 'max_value',
                            label: 'Maximum Value',
                            type: 'number',
                            required: false,
                            help: 'Maximum acceptable value (inclusive)'
                        }
                    ],
                    examples: 'Age: min_value: 0, max_value: 120',
                    tips: 'Set realistic bounds based on business rules'
                },

                'DateFormatCheck': {
                    icon: 'ðŸ“…',
                    name: 'Date Format Check',
                    type: 'DateFormatCheck',
                    category: 'Field-Level',
                    description: 'Validates date fields match expected format',
                    params: [
                        {
                            name: 'field',
                            label: 'Field Name',
                            type: 'text',
                            required: true,
                            help: 'Date field to validate'
                        },
                        {
                            name: 'format',
                            label: 'Date Format',
                            type: 'text',
                            required: true,
                            help: 'Expected date format (e.g., %Y-%m-%d for 2024-01-15)'
                        }
                    ],
                    examples: 'ISO date: format: %Y-%m-%d, US date: format: %m/%d/%Y',
                    tips: 'Common formats: %Y-%m-%d (2024-01-15), %d/%m/%Y (15/01/2024)'
                },

                // Record-Level Validations
                'DuplicateRowCheck': {
                    icon: 'ðŸ”„',
                    name: 'Duplicate Row Check',
                    type: 'DuplicateRowCheck',
                    category: 'Record-Level',
                    description: 'Detects duplicate rows based on key fields. Optimized with bloom filters and early termination for large datasets',
                    params: [
                        {
                            name: 'key_fields',
                            label: 'Key Fields (comma-separated)',
                            type: 'text',
                            required: false,
                            help: 'Fields to use for duplicate detection (leave empty for all fields)'
                        },
                        {
                            name: 'consider_all_fields',
                            label: 'Consider All Fields',
                            type: 'checkbox',
                            required: false,
                            help: 'Check for duplicates across all columns'
                        },
                        {
                            name: 'use_bloom_filter',
                            label: 'Use Bloom Filter',
                            type: 'checkbox',
                            required: false,
                            help: 'Enable bloom filter for fast duplicate pre-filtering (default: true, 10x faster)'
                        },
                        {
                            name: 'bloom_false_positive_rate',
                            label: 'Bloom FP Rate',
                            type: 'number',
                            required: false,
                            help: 'Bloom filter false positive rate (default: 0.01 = 1%)'
                        },
                        {
                            name: 'hash_table_size',
                            label: 'Hash Table Size',
                            type: 'number',
                            required: false,
                            help: 'In-memory hash table size before disk spillover (default: 10M, recommend 50M for large files)'
                        },
                        {
                            name: 'enable_early_termination',
                            label: 'Enable Early Termination',
                            type: 'checkbox',
                            required: false,
                            help: 'Stop after finding N duplicates (default: true, 42x faster for validation)'
                        },
                        {
                            name: 'max_duplicates',
                            label: 'Max Duplicates',
                            type: 'number',
                            required: false,
                            help: 'Maximum duplicates to find before stopping (default: 100)'
                        }
                    ],
                    examples: 'Fast validation: key_fields: [Timestamp, From Bank, Amount], enable_early_termination: true, hash_table_size: 50000000',
                    tips: 'Use WARNING severity. Enable early termination for validation (42x faster). Disable for data cleanup.'
                },

                'BlankRecordCheck': {
                    icon: 'â¬œ',
                    name: 'Blank Record Check',
                    type: 'BlankRecordCheck',
                    category: 'Record-Level',
                    description: 'Detects rows where all fields are empty or null',
                    params: [
                        {
                            name: 'exclude_fields',
                            label: 'Exclude Fields (comma-separated)',
                            type: 'text',
                            required: false,
                            help: 'Fields to ignore when checking for blank rows'
                        }
                    ],
                    examples: 'Find completely empty rows (common in Excel extracts)',
                    tips: 'Useful for cleaning up extracts with trailing empty rows'
                },

                'UniqueKeyCheck': {
                    icon: 'ðŸ”‘',
                    name: 'Unique Key Check',
                    type: 'UniqueKeyCheck',
                    category: 'Record-Level',
                    description: 'Validates that key field combinations are unique. Optimized with bloom filters and early termination for large datasets',
                    params: [
                        {
                            name: 'fields',
                            label: 'Key Fields (comma-separated)',
                            type: 'text',
                            required: true,
                            help: 'Fields that should form a unique key'
                        },
                        {
                            name: 'use_bloom_filter',
                            label: 'Use Bloom Filter',
                            type: 'checkbox',
                            required: false,
                            help: 'Enable bloom filter for fast duplicate pre-filtering (default: true, 10x faster)'
                        },
                        {
                            name: 'bloom_false_positive_rate',
                            label: 'Bloom FP Rate',
                            type: 'number',
                            required: false,
                            help: 'Bloom filter false positive rate (default: 0.01 = 1%)'
                        },
                        {
                            name: 'hash_table_size',
                            label: 'Hash Table Size',
                            type: 'number',
                            required: false,
                            help: 'In-memory hash table size before disk spillover (default: 10M, recommend 50M for large files)'
                        },
                        {
                            name: 'enable_early_termination',
                            label: 'Enable Early Termination',
                            type: 'checkbox',
                            required: false,
                            help: 'Stop after finding N duplicates (default: true, 80x faster for validation)'
                        },
                        {
                            name: 'max_duplicates',
                            label: 'Max Duplicates',
                            type: 'number',
                            required: false,
                            help: 'Maximum duplicates to find before stopping (default: 100)'
                        }
                    ],
                    examples: 'Fast validation: fields: [customer_id, order_id], enable_early_termination: true, hash_table_size: 50000000',
                    tips: 'Use ERROR severity. Enable early termination for validation (80x faster). Disable for data cleanup.'
                },

                // Advanced Validations
                'StatisticalOutlierCheck': {
                    icon: 'ðŸ“Š',
                    name: 'Statistical Outlier Check',
                    type: 'StatisticalOutlierCheck',
                    category: 'Advanced',
                    description: 'Detects statistical outliers using z-score or IQR methods. IQR method supports smart sampling for large datasets (10M+ rows)',
                    params: [
                        {
                            name: 'field',
                            label: 'Field Name',
                            type: 'text',
                            required: true,
                            help: 'Numeric field to analyze for outliers'
                        },
                        {
                            name: 'method',
                            label: 'Detection Method',
                            type: 'select',
                            options: ['zscore', 'iqr'],
                            required: false,
                            help: 'Method: zscore (standard deviations) or iqr (interquartile range)'
                        },
                        {
                            name: 'threshold',
                            label: 'Threshold',
                            type: 'number',
                            required: false,
                            help: 'Threshold value (e.g., 3 for z-score, 1.5 for IQR)'
                        },
                        {
                            name: 'enable_sampling',
                            label: 'Enable Sampling (IQR only)',
                            type: 'checkbox',
                            required: false,
                            help: 'Enable smart sampling for IQR method (auto-enabled for 10M+ rows, 20x faster)'
                        },
                        {
                            name: 'sample_size',
                            label: 'Sample Size',
                            type: 'number',
                            required: false,
                            help: 'Number of rows to sample (default: 10,000,000)'
                        },
                        {
                            name: 'sampling_method',
                            label: 'Sampling Method',
                            type: 'select',
                            options: ['stratified', 'random'],
                            required: false,
                            help: 'Sampling method: stratified (preserves distribution) or random'
                        },
                        {
                            name: 'min_sample_size',
                            label: 'Min Sample Size',
                            type: 'number',
                            required: false,
                            help: 'Minimum sample size for statistical validity (default: 100,000)'
                        },
                        {
                            name: 'confidence_level',
                            label: 'Confidence Level',
                            type: 'number',
                            required: false,
                            help: 'Statistical confidence level (default: 0.95 for 95%)'
                        }
                    ],
                    examples: 'Fast IQR with sampling: field: price, method: iqr, threshold: 1.5, enable_sampling: true',
                    tips: 'Use WARNING severity. Enable sampling for datasets >10M rows (20x faster). Z-score does not need sampling.'
                },

                'CrossFieldComparisonCheck': {
                    icon: 'âš–ï¸',
                    name: 'Cross-Field Comparison',
                    type: 'CrossFieldComparisonCheck',
                    category: 'Advanced',
                    description: 'Compares two fields using logical operators',
                    params: [
                        {
                            name: 'field_a',
                            label: 'Field A',
                            type: 'text',
                            required: true,
                            help: 'First field to compare'
                        },
                        {
                            name: 'operator',
                            label: 'Operator',
                            type: 'select',
                            options: ['>', '<', '>=', '<=', '==', '!='],
                            required: true,
                            help: 'Comparison operator'
                        },
                        {
                            name: 'field_b',
                            label: 'Field B',
                            type: 'text',
                            required: true,
                            help: 'Second field to compare'
                        }
                    ],
                    examples: 'End date after start: field_a: end_date, operator: >=, field_b: start_date',
                    tips: 'Essential for temporal and logical consistency checks'
                },

                'FreshnessCheck': {
                    icon: 'â°',
                    name: 'Freshness Check',
                    type: 'FreshnessCheck',
                    category: 'Advanced',
                    description: 'Validates data or file freshness (not too old)',
                    params: [
                        {
                            name: 'check_type',
                            label: 'Check Type',
                            type: 'select',
                            options: ['file', 'data'],
                            required: false,
                            help: 'Check file timestamp or data field'
                        },
                        {
                            name: 'max_age_hours',
                            label: 'Max Age (hours)',
                            type: 'number',
                            required: true,
                            help: 'Maximum acceptable age in hours'
                        },
                        {
                            name: 'date_field',
                            label: 'Date Field (for data check)',
                            type: 'text',
                            required: false,
                            help: 'Field containing timestamp (required if check_type is data)'
                        }
                    ],
                    examples: 'Daily file: check_type: file, max_age_hours: 24',
                    tips: 'Critical for time-sensitive data pipelines'
                },

                'CompletenessCheck': {
                    icon: 'âœ”ï¸',
                    name: 'Completeness Check',
                    type: 'CompletenessCheck',
                    category: 'Advanced',
                    description: 'Validates minimum percentage of non-null values in a field',
                    params: [
                        {
                            name: 'field',
                            label: 'Field Name',
                            type: 'text',
                            required: true,
                            help: 'Field to check completeness'
                        },
                        {
                            name: 'min_completeness',
                            label: 'Min Completeness (0.0-1.0)',
                            type: 'number',
                            required: true,
                            help: 'Minimum acceptable completeness (e.g., 0.95 for 95%)'
                        }
                    ],
                    examples: 'Optional field 80% complete: field: phone, min_completeness: 0.8',
                    tips: 'Use for fields that should be mostly populated'
                },

                'StringLengthCheck': {
                    icon: 'ðŸ“',
                    name: 'String Length Check',
                    type: 'StringLengthCheck',
                    category: 'Advanced',
                    description: 'Validates string field length is within bounds',
                    params: [
                        {
                            name: 'field',
                            label: 'Field Name',
                            type: 'text',
                            required: true,
                            help: 'String field to validate'
                        },
                        {
                            name: 'min_length',
                            label: 'Min Length',
                            type: 'number',
                            required: false,
                            help: 'Minimum string length'
                        },
                        {
                            name: 'max_length',
                            label: 'Max Length',
                            type: 'number',
                            required: false,
                            help: 'Maximum string length'
                        }
                    ],
                    examples: 'Product code: min_length: 3, max_length: 10',
                    tips: 'Useful for catching truncation or malformed data'
                },

                'NumericPrecisionCheck': {
                    icon: 'ðŸ”¢',
                    name: 'Numeric Precision Check',
                    type: 'NumericPrecisionCheck',
                    category: 'Advanced',
                    description: 'Validates decimal places in numeric fields',
                    params: [
                        {
                            name: 'field',
                            label: 'Field Name',
                            type: 'text',
                            required: true,
                            help: 'Numeric field to validate'
                        },
                        {
                            name: 'max_decimal_places',
                            label: 'Max Decimal Places',
                            type: 'number',
                            required: false,
                            help: 'Maximum allowed decimal places'
                        },
                        {
                            name: 'exact_decimal_places',
                            label: 'Exact Decimal Places',
                            type: 'number',
                            required: false,
                            help: 'Exact number of decimal places required'
                        }
                    ],
                    examples: 'Currency: exact_decimal_places: 2',
                    tips: 'Important for financial data consistency'
                },

                // Cross-File Validations
                'ReferentialIntegrityCheck': {
                    icon: 'ðŸ”—',
                    name: 'Referential Integrity Check',
                    type: 'ReferentialIntegrityCheck',
                    category: 'Cross-File',
                    description: 'Validates foreign key relationships between files',
                    params: [
                        {
                            name: 'foreign_key',
                            label: 'Foreign Key Column',
                            type: 'text',
                            required: true,
                            help: 'Column in this file containing foreign key'
                        },
                        {
                            name: 'reference_file',
                            label: 'Reference File Path',
                            type: 'text',
                            required: true,
                            help: 'Path to file containing referenced data'
                        },
                        {
                            name: 'reference_key',
                            label: 'Reference Key Column',
                            type: 'text',
                            required: true,
                            help: 'Column in reference file containing primary key'
                        },
                        {
                            name: 'allow_null',
                            label: 'Allow Null',
                            type: 'checkbox',
                            required: false,
                            help: 'Allow null foreign key values'
                        },
                        {
                            name: 'reference_file_format',
                            label: 'Reference Format',
                            type: 'select',
                            options: ['csv', 'parquet', 'excel', 'json'],
                            required: false,
                            help: 'Format of reference file'
                        }
                    ],
                    examples: 'Orders reference customers: foreign_key: customer_id, reference_file: customers.csv, reference_key: id',
                    tips: 'Critical for maintaining data integrity across related files'
                },

                'CrossFileComparisonCheck': {
                    icon: 'ðŸ“Š',
                    name: 'Cross-File Comparison',
                    type: 'CrossFileComparisonCheck',
                    category: 'Cross-File',
                    description: 'Compares aggregated values between two files',
                    params: [
                        {
                            name: 'aggregation',
                            label: 'Aggregation Type',
                            type: 'select',
                            options: ['sum', 'count', 'mean', 'min', 'max'],
                            required: true,
                            help: 'Aggregation to perform on this file'
                        },
                        {
                            name: 'column',
                            label: 'Column Name',
                            type: 'text',
                            required: false,
                            help: 'Column to aggregate (not needed for count)'
                        },
                        {
                            name: 'comparison',
                            label: 'Comparison Operator',
                            type: 'select',
                            options: ['==', '!=', '>', '<', '>=', '<='],
                            required: true,
                            help: 'How to compare the aggregates'
                        },
                        {
                            name: 'reference_file',
                            label: 'Reference File',
                            type: 'text',
                            required: true,
                            help: 'File to compare against'
                        },
                        {
                            name: 'reference_aggregation',
                            label: 'Reference Aggregation',
                            type: 'select',
                            options: ['sum', 'count', 'mean', 'min', 'max'],
                            required: true,
                            help: 'Aggregation to perform on reference file'
                        },
                        {
                            name: 'reference_column',
                            label: 'Reference Column',
                            type: 'text',
                            required: false,
                            help: 'Column in reference file to aggregate'
                        },
                        {
                            name: 'tolerance',
                            label: 'Tolerance (absolute)',
                            type: 'number',
                            required: false,
                            help: 'Acceptable absolute difference'
                        },
                        {
                            name: 'tolerance_pct',
                            label: 'Tolerance (%)',
                            type: 'number',
                            required: false,
                            help: 'Acceptable percentage difference'
                        }
                    ],
                    examples: 'Order totals match: aggregation: sum, column: total, comparison: ==, reference_file: summary.csv',
                    tips: 'Use tolerance for floating-point comparisons'
                },

                'CrossFileDuplicateCheck': {
                    icon: 'ðŸ”',
                    name: 'Cross-File Duplicate Check',
                    type: 'CrossFileDuplicateCheck',
                    category: 'Cross-File',
                    description: 'Finds duplicate records across multiple files',
                    params: [
                        {
                            name: 'columns',
                            label: 'Columns to Check (comma-separated)',
                            type: 'text',
                            required: true,
                            help: 'Columns to use for duplicate detection'
                        },
                        {
                            name: 'reference_files',
                            label: 'Reference Files (comma-separated)',
                            type: 'textarea',
                            required: true,
                            help: 'Paths to files to check for duplicates'
                        },
                        {
                            name: 'reference_file_format',
                            label: 'Reference Format',
                            type: 'select',
                            options: ['csv', 'parquet', 'excel', 'json'],
                            required: false,
                            help: 'Format of reference files'
                        }
                    ],
                    examples: 'No duplicate IDs across files: columns: [customer_id], reference_files: [archive1.csv, archive2.csv]',
                    tips: 'Useful for preventing duplicates in incremental loads'
                }
            },  // End of fallbackValidationLibrary

            /* ====================================================================
               JSON Loading Functions
               ==================================================================== */

            /**
             * Load validation definitions from JSON file
             * @returns {Promise<Object>} Transformed validation library
             */
            async loadValidationDefinitions() {
                try {
                    console.log('Loading validation definitions from JSON...');
                    const response = await fetch('./validation_definitions.json');

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const jsonData = await response.json();
                    console.log(`Loaded ${Object.keys(jsonData).length - 1} validation types from JSON`);

                    return this.transformDefinitionsToStudioFormat(jsonData);
                } catch (error) {
                    console.error('Failed to load validation definitions from JSON:', error);
                    console.warn('Falling back to hardcoded definitions');
                    return this.fallbackValidationLibrary;
                }
            },

            /**
             * Transform JSON definitions to Studio format
             * @param {Object} jsonDefs - Raw JSON definitions
             * @returns {Object} Studio-formatted validation library
             */
            transformDefinitionsToStudioFormat(jsonDefs) {
                const library = {};

                for (const [type, def] of Object.entries(jsonDefs)) {
                    // Skip metadata entry
                    if (type === '_metadata') continue;

                    library[type] = {
                        icon: def.icon || 'ðŸ“‹',
                        name: this.formatValidationName(type),
                        type: type,
                        category: def.category || 'Other',
                        description: def.description || '',
                        params: this.transformParams(def.params || []),
                        examples: def.examples || '',
                        tips: def.tips || '',
                        severity_recommendation: def.severity_recommendation
                    };
                }

                return library;
            },

            /**
             * Transform JSON param definitions to Studio format
             * @param {Array} params - Array of parameter definitions
             * @returns {Array} Studio-formatted parameters
             */
            transformParams(params) {
                return params.map(param => ({
                    name: param.name,
                    label: this.formatParamLabel(param.name),
                    type: this.mapParamType(param.type),
                    required: param.required || false,
                    help: param.description || '',
                    default: param.default
                }));
            },

            /**
             * Format validation type name for display
             * @param {string} type - e.g., "EmptyFileCheck"
             * @returns {string} - e.g., "Empty File Check"
             */
            formatValidationName(type) {
                return type
                    .replace(/([A-Z])/g, ' $1')  // Add space before capitals
                    .trim()                       // Remove leading space
                    .replace(/Check$/, ' Check'); // Ensure "Check" has space
            },

            /**
             * Format parameter name for label display
             * @param {string} name - e.g., "min_rows"
             * @returns {string} - e.g., "Min Rows"
             */
            formatParamLabel(name) {
                return name
                    .split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            },

            /**
             * Map JSON param types to Studio input types
             * @param {string} type - JSON type
             * @returns {string} - HTML input type
             */
            mapParamType(type) {
                const typeMap = {
                    'string': 'text',
                    'int': 'number',
                    'float': 'number',
                    'bool': 'checkbox',
                    'list': 'text',
                    'dict': 'textarea'
                };
                return typeMap[type] || 'text';
            },

            /* ====================================================================
               Application Initialization
               ==================================================================== */

            async init() {
                try {
                    console.log('Initializing DataK9 Studio...');

                    // Show loading indicator
                    this.showLoadingIndicator('Loading validation definitions...');

                    // Phase 2: Load validation definitions with proper error handling
                    try {
                        this.validationLibrary = await this.loadValidationDefinitions();
                        console.log(`Loaded ${Object.keys(this.validationLibrary).length} validations into library`);
                    } catch (error) {
                        console.error('Failed to load validation definitions:', error);
                        // Use fallback library
                        this.validationLibrary = this.fallbackValidationLibrary;
                        console.warn('Using fallback validation library');
                    }

                    // Load saved project from localStorage if exists
                    this.loadFromLocalStorage();

                    // Phase 3: Check if project was loaded and mark as open
                    if (this.config.validation_job?.name || this.config.files?.length > 0) {
                        this.updateProjectState(true, null);  // Project loaded from localStorage
                        this.markSaved();  // Loaded projects start as saved
                    } else {
                        this.updateProjectState(false);  // No project loaded
                    }

                    // Initialize Monaco Editor
                    this.initMonacoEditor();

                    // Set up keyboard shortcuts
                    this.initKeyboardShortcuts();

                    // Render initial UI state
                    this.render();

                    // Hide loading indicator
                    this.hideLoadingIndicator();

                    console.log('DataK9 Studio initialized successfully');
                } catch (error) {
                    console.error('Initialization failed:', error);
                    this.hideLoadingIndicator();

                    // Show error to user
                    alert('Failed to initialize DataK9 Studio. Please refresh the page.\n\nError: ' + error.message);
                }
            },

            /**
             * Show loading indicator overlay
             * @param {string} message - Loading message to display
             */
            showLoadingIndicator(message = 'Loading...') {
                const existingLoader = document.getElementById('loading-overlay');
                if (existingLoader) return;

                const overlay = document.createElement('div');
                overlay.id = 'loading-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(30, 30, 30, 0.95);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    font-family: var(--font-sans);
                `;

                overlay.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ•</div>
                        <div style="font-size: 18px; color: var(--k9-blue); margin-bottom: 8px;">DataK9 Studio</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">${message}</div>
                        <div style="margin-top: 20px;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                `;

                // Add spinner CSS if not already present
                if (!document.getElementById('spinner-style')) {
                    const style = document.createElement('style');
                    style.id = 'spinner-style';
                    style.textContent = `
                        .loading-spinner {
                            border: 3px solid rgba(74, 144, 226, 0.3);
                            border-top: 3px solid var(--k9-blue);
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            animation: spin 1s linear infinite;
                            margin: 0 auto;
                        }
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }

                document.body.appendChild(overlay);
            },

            /**
             * Hide loading indicator overlay
             */
            hideLoadingIndicator() {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
            },

            /* ====================================================================
               Monaco Editor Initialization
               ==================================================================== */

            initMonacoEditor() {
                require.config({
                    paths: {
                        'vs': 'monaco-editor/min/vs'
                    }
                });

                require(['vs/editor/editor.main'], () => {
                    this.monacoEditor = monaco.editor.create(
                        document.getElementById('monaco-editor'),
                        {
                            value: this.generateYAML(),
                            language: 'yaml',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: true },
                            fontSize: 13,
                            lineNumbers: 'on',
                            roundedSelection: false,
                            scrollBeyondLastLine: false,
                            readOnly: true,  // Start locked
                            cursorStyle: 'line',
                            wordWrap: 'on'
                        }
                    );

                    // Listen for changes in Monaco Editor
                    // Note: We don't sync on every keystroke as YAML will be invalid while typing
                    // Instead, mark as having unsaved changes and sync only when user saves
                    this.monacoEditor.onDidChangeModelContent(() => {
                        if (!this.isSyncing) {
                            this.projectState.hasUnsavedChanges = true;
                            this.updateStatusBar();
                        }
                    });

                    console.log('Monaco Editor initialized (locked)');
                });
            },

            /* ====================================================================
               Keyboard Shortcuts
               ==================================================================== */

            initKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + S: Export YAML (with filename prompt)
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        this.exportYAML();
                    }
                    // Ctrl/Cmd + R: Sync from YAML
                    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                        e.preventDefault();
                        this.syncFromYAML();
                    }
                    // Ctrl/Cmd + N: New project
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                        e.preventDefault();
                        this.startNewProject();
                    }
                    // Ctrl/Cmd + O: Open Project
                    if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                        e.preventDefault();
                        this.openProjectDialog();
                    }

                    // Validation management shortcuts (only when a validation is selected)
                    if (this.selectedFile !== null && this.selectedValidation !== null) {
                        // Ctrl/Cmd + D: Duplicate selected validation
                        if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                            e.preventDefault();
                            this.duplicateValidation(this.selectedFile, this.selectedValidation);
                        }
                        // Ctrl/Cmd + Up Arrow: Move validation up
                        if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowUp') {
                            e.preventDefault();
                            this.moveValidationUp(this.selectedFile, this.selectedValidation);
                        }
                        // Ctrl/Cmd + Down Arrow: Move validation down
                        if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowDown') {
                            e.preventDefault();
                            this.moveValidationDown(this.selectedFile, this.selectedValidation);
                        }
                        // Delete key: Delete selected validation
                        if (e.key === 'Delete') {
                            e.preventDefault();
                            if (confirm('Delete this validation?')) {
                                const file = this.config.files[this.selectedFile];
                                file.validations.splice(this.selectedValidation, 1);
                                this.selectedValidation = null;
                                this.updateYAMLEditor();
                                this.saveToLocalStorage();
                                this.render();
                            }
                        }
                    }
                });

                // Phase 5: Close menus when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.menu-item')) {
                        this.closeAllMenus();
                    }
                });
            },

            /* ====================================================================
               Rendering Functions
               ==================================================================== */

            render() {
                this.renderFileTree();
                this.renderVisualEditor();
                this.updateYAMLEditor();
                this.updateValidationSummary();
                this.updateHelpPanel();

                // Show/hide welcome screen vs editor
                const hasProject = this.config.validation_job.name !== '';
                document.getElementById('welcome-screen').classList.toggle('hidden', hasProject);
                document.getElementById('editor-view').classList.toggle('hidden', !hasProject);
            },

            renderFileTree() {
                const container = document.getElementById('file-tree');

                let html = '';

                // Only show Project Settings if a project is open
                if (this.projectState.isOpen) {
                    // Project Settings Section
                    const projectName = this.config.validation_job?.name || 'Untitled Project';
                    const projectDescription = this.config.validation_job?.description || '';
                    const settings = this.config.settings || {};
                    const settingsExpanded = this.projectSettingsExpanded || false;

                    html += `
                        <div class="config-section">
                            <div class="project-settings-item">
                                <div class="project-settings-header" onclick="app.toggleProjectSettings()">
                                    <div class="project-settings-info">
                                        <span class="project-settings-icon">ðŸ”§</span>
                                        <span class="project-settings-title">Project Settings</span>
                                    </div>
                                    <span style="font-size: 12px;">${settingsExpanded ? 'â–¼' : 'â–¶'}</span>
                                </div>
                                <div class="project-settings-content ${settingsExpanded ? 'expanded' : ''}">
                                    <div class="settings-field">
                                        <label for="project-name-input">Project Name</label>
                                        <input type="text"
                                               id="project-name-input"
                                               value="${this.escapeHtml(projectName)}"
                                               oninput="app.updateProjectName(this.value)"
                                               placeholder="Enter project name">
                                    </div>
                                    <div class="settings-field">
                                        <label for="project-description-input">Description</label>
                                        <textarea id="project-description-input"
                                                  oninput="app.updateProjectDescription(this.value)"
                                                  placeholder="Enter project description">${this.escapeHtml(projectDescription)}</textarea>
                                    </div>
                                    <div class="settings-grid">
                                        <div class="settings-field">
                                            <label for="max-sample-failures-input">Max Sample Failures</label>
                                            <input type="number"
                                                   id="max-sample-failures-input"
                                                   value="${settings.max_sample_failures || 100}"
                                                   oninput="app.updateProjectSetting('max_sample_failures', parseInt(this.value))"
                                                   min="1">
                                        </div>
                                        <div class="settings-field">
                                            <label for="chunk-size-input">Chunk Size</label>
                                            <input type="number"
                                                   id="chunk-size-input"
                                                   value="${settings.chunk_size || 50000}"
                                                   oninput="app.updateProjectSetting('chunk_size', parseInt(this.value))"
                                                   min="1000"
                                                   step="1000">
                                        </div>
                                    </div>
                                    <div class="settings-grid">
                                        <div class="settings-field">
                                            <label for="parallel-processing-input">Parallel Processing</label>
                                            <select id="parallel-processing-input"
                                                    onchange="app.updateProjectSetting('parallel_processing', this.value === 'true')">
                                                <option value="true" ${settings.parallel_processing !== false ? 'selected' : ''}>Enabled</option>
                                                <option value="false" ${settings.parallel_processing === false ? 'selected' : ''}>Disabled</option>
                                            </select>
                                        </div>
                                        <div class="settings-field">
                                            <label for="stop-on-first-failure-input">Stop on First Failure</label>
                                            <select id="stop-on-first-failure-input"
                                                    onchange="app.updateProjectSetting('stop_on_first_failure', this.value === 'true')">
                                                <option value="false" ${!settings.stop_on_first_failure ? 'selected' : ''}>No</option>
                                                <option value="true" ${settings.stop_on_first_failure ? 'selected' : ''}>Yes</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Data Files Section (only show if project is open)
                if (this.projectState.isOpen) {
                html += `
                    <div class="config-section">
                        <div class="config-section-header">
                            <span>ðŸ“ Data Files (${this.config.files.length})</span>
                            <button class="btn btn-primary btn-small" onclick="app.addFile()" style="padding: 2px 8px; font-size: 11px;">
                                + Add
                            </button>
                        </div>
                `;

                if (this.config.files.length === 0) {
                    html += '<div style="padding: 16px; text-align: center; color: var(--text-muted); font-size: 12px;">No data files added yet</div>';
                } else {
                this.config.files.forEach((file, fileIndex) => {
                    const isSelected = this.selectedFile === fileIndex;
                    const isExpanded = true; // Always expanded for simplicity

                    html += `
                        <div class="file-item ${isExpanded ? 'expanded' : ''}"
                             draggable="true"
                             data-file-index="${fileIndex}"
                             ondragstart="app.handleFileDragStart(event, ${fileIndex})"
                             ondragend="app.handleFileDragEnd(event)"
                             ondragover="app.handleFileDragOver(event)"
                             ondrop="app.handleFileDrop(event, ${fileIndex})">
                            <div class="file-header ${isSelected ? 'selected' : ''}" onclick="app.selectFile(${fileIndex})">
                                <div class="file-info">
                                    <span class="file-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()">â‹®â‹®</span>
                                    <span class="file-icon">ðŸ“„</span>
                                    <span class="file-name">${this.escapeHtml(file.name || 'Unnamed')}</span>
                                    <span class="file-format-badge">${this.escapeHtml(file.format || 'csv').toUpperCase()}</span>
                                </div>
                                <div class="file-actions">
                                    <button class="file-action-btn" onclick="event.stopPropagation(); app.addValidationToFile(${fileIndex})" title="Add Validation">
                                        +
                                    </button>
                                    <button class="file-action-btn" onclick="event.stopPropagation(); app.deleteFile(${fileIndex})" title="Delete File">
                                        ðŸ—‘ï¸
                                    </button>
                                </div>
                            </div>
                            <div class="validations-list">
                    `;

                    if (file.validations && file.validations.length > 0) {
                        file.validations.forEach((validation, valIndex) => {
                            const isValSelected = this.selectedFile === fileIndex && this.selectedValidation === valIndex;
                            const severity = validation.severity || 'ERROR';
                            const valDef = this.validationLibrary[validation.type];
                            const icon = valDef ? valDef.icon : 'âœ“';
                            const name = valDef ? valDef.name : validation.type;

                            html += `
                                <div class="validation-item ${isValSelected ? 'selected' : ''} ${severity.toLowerCase()}-severity"
                                     draggable="true"
                                     data-file-index="${fileIndex}"
                                     data-validation-index="${valIndex}"
                                     onclick="app.selectValidation(${fileIndex}, ${valIndex})"
                                     oncontextmenu="app.showValidationContextMenu(event, ${fileIndex}, ${valIndex}); return false;"
                                     ondragstart="app.handleValidationDragStart(event, ${fileIndex}, ${valIndex})"
                                     ondragend="app.handleValidationDragEnd(event)"
                                     ondragover="app.handleValidationDragOver(event)"
                                     ondrop="app.handleValidationDrop(event, ${fileIndex}, ${valIndex})"
                                     ontouchstart="app.handleValidationTouchStart(event, ${fileIndex}, ${valIndex})"
                                     ontouchmove="app.handleValidationTouchMove(event)"
                                     ontouchend="app.handleValidationTouchEnd(event)">
                                    <span class="validation-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()">â˜°</span>
                                    <div class="validation-info">
                                        <span class="validation-icon">${this.escapeHtml(icon)}</span>
                                        <span class="validation-name">${this.escapeHtml(name)}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <span class="severity-badge ${severity.toLowerCase()}">${this.escapeHtml(severity)}</span>
                                        <div class="validation-actions">
                                            <button class="validation-action-btn"
                                                    onclick="event.stopPropagation(); app.moveValidationUp(${fileIndex}, ${valIndex})"
                                                    title="Move Up"
                                                    ${valIndex === 0 ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}>
                                                â†‘
                                            </button>
                                            <button class="validation-action-btn"
                                                    onclick="event.stopPropagation(); app.moveValidationDown(${fileIndex}, ${valIndex})"
                                                    title="Move Down"
                                                    ${valIndex === file.validations.length - 1 ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}>
                                                â†“
                                            </button>
                                            <button class="validation-action-btn duplicate-btn"
                                                    onclick="event.stopPropagation(); app.duplicateValidation(${fileIndex}, ${valIndex})"
                                                    title="Duplicate validation">
                                                ðŸ“‹
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += '<div style="padding: 8px; font-size: 11px; color: var(--text-muted); text-align: center;">No validations yet</div>';
                    }

                    html += `
                            </div>
                        </div>
                    `;
                });
                }

                html += `</div>`; // Close config-section for Data Files
                } // Close if (this.projectState.isOpen)

                container.innerHTML = html;
            },

            /**
             * Toggle Project Settings panel
             */
            toggleProjectSettings() {
                this.projectSettingsExpanded = !this.projectSettingsExpanded;
                this.renderFileTree();
            },

            /**
             * Update project name
             */
            updateProjectName(name) {
                if (!this.config.validation_job) {
                    this.config.validation_job = {};
                }
                this.config.validation_job.name = name;
                this.updateYAMLEditor();
                this.markAsModified();
            },

            /**
             * Update project description
             */
            updateProjectDescription(description) {
                if (!this.config.validation_job) {
                    this.config.validation_job = {};
                }
                this.config.validation_job.description = description;
                this.updateYAMLEditor();
                this.markAsModified();
            },

            /**
             * Update project setting
             */
            updateProjectSetting(key, value) {
                if (!this.config.validation_job) {
                    this.config.validation_job = {};
                }
                if (!this.config.validation_job.settings) {
                    this.config.validation_job.settings = {};
                }
                if (!this.config.settings) {
                    this.config.settings = {};
                }
                // Update both locations to keep them in sync
                this.config.validation_job.settings[key] = value;
                this.config.settings[key] = value;
                this.updateYAMLEditor();
                this.markAsModified();
            },

            renderVisualEditor() {
                const container = document.getElementById('visual-editor');

                if (this.selectedFile === null) {
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“„</div>
                                <div style="font-size: 16px; margin-bottom: 8px;">No file selected</div>
                                <div style="font-size: 13px;">Select a file from the sidebar or add a new one</div>
                            </div>
                        </div>
                    `;
                    return;
                }

                const file = this.config.files[this.selectedFile];

                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3>ðŸ“„ File: ${this.escapeHtml(file.name)}</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">File Name</label>
                                <input type="text" class="form-input" value="${this.escapeHtml(file.name)}"
                                       onchange="app.updateFileName(${this.selectedFile}, this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">File Path</label>
                                <input type="text" class="form-input" value="${this.escapeHtml(file.path)}"
                                       onchange="app.updateFilePath(${this.selectedFile}, this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Format</label>
                                <select class="form-select" onchange="app.updateFileFormat(${this.selectedFile}, this.value)">
                                    <option value="csv" ${file.format === 'csv' ? 'selected' : ''}>CSV</option>
                                    <option value="excel" ${file.format === 'excel' ? 'selected' : ''}>Excel</option>
                                    <option value="json" ${file.format === 'json' ? 'selected' : ''}>JSON</option>
                                    <option value="parquet" ${file.format === 'parquet' ? 'selected' : ''}>Parquet</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>âœ“ Validations (${file.validations ? file.validations.length : 0})</h3>
                            <button class="btn btn-primary btn-small" onclick="app.addValidationToFile(${this.selectedFile})">
                                + Add Validation
                            </button>
                        </div>
                        <div class="card-body">
                `;

                if (!file.validations || file.validations.length === 0) {
                    html += '<div style="text-align: center; padding: 32px; color: var(--text-muted);">No validations configured yet</div>';
                } else {
                    html += '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">Click a validation in the sidebar to edit it</div>';
                }

                html += `
                        </div>
                    </div>
                `;

                if (this.selectedValidation !== null) {
                    const validation = file.validations[this.selectedValidation];
                    const valDef = this.validationLibrary[validation.type];

                    if (valDef) {
                        html += `
                            <div class="card" style="border: 2px solid var(--k9-blue);">
                                <div class="card-header">
                                    <h3>${valDef.icon} ${valDef.name}</h3>
                                </div>
                                <div class="card-body">
                                    <p style="color: var(--text-secondary); margin-bottom: 16px;">${valDef.description}</p>

                                    <div class="form-group">
                                        <label class="form-label">Severity</label>
                                        <select class="form-select" id="edit-severity">
                                            <option value="ERROR" ${validation.severity === 'ERROR' ? 'selected' : ''}>ERROR</option>
                                            <option value="WARNING" ${validation.severity === 'WARNING' ? 'selected' : ''}>WARNING</option>
                                        </select>
                                        <div class="form-help">Use ERROR for critical requirements, WARNING for quality issues</div>
                                    </div>
                        `;

                        // Render parameter fields
                        valDef.params.forEach(param => {
                            const currentValue = validation.params && validation.params[param.name] !== undefined
                                ? validation.params[param.name]
                                : '';

                            html += `<div class="form-group">`;
                            html += `<label class="form-label ${param.required ? 'form-label-required' : ''}">${param.label}</label>`;

                            if (param.type === 'select') {
                                html += `<select class="form-select" id="edit-param-${param.name}">`;
                                html += `<option value="">-- Select --</option>`;
                                param.options.forEach(opt => {
                                    html += `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`;
                                });
                                html += `</select>`;
                            } else if (param.type === 'checkbox') {
                                html += `
                                    <div class="form-checkbox-group">
                                        <input type="checkbox" class="form-checkbox" id="edit-param-${param.name}"
                                               ${currentValue ? 'checked' : ''}>
                                        <label class="form-label mb-0">${param.help || 'Enable'}</label>
                                    </div>
                                `;
                            } else if (param.type === 'textarea') {
                                html += `<textarea class="form-textarea" id="edit-param-${param.name}">${currentValue}</textarea>`;
                            } else if (param.type === 'number') {
                                html += `<input type="number" step="any" class="form-input" id="edit-param-${param.name}" value="${currentValue}">`;
                            } else {
                                html += `<input type="text" class="form-input" id="edit-param-${param.name}" value="${currentValue}">`;
                            }

                            if (param.help && param.type !== 'checkbox') {
                                html += `<div class="form-help">${param.help}</div>`;
                            }
                            html += `</div>`;
                        });

                        html += `
                                    <div class="form-group">
                                        <label class="form-label">Condition (Optional)</label>
                                        <input type="text" class="form-input" id="edit-condition"
                                               value="${validation.condition || ''}"
                                               placeholder="e.g., row['status'] == 'active'">
                                        <div class="form-help">Python expression for conditional execution</div>
                                    </div>

                                    <div style="display: flex; gap: 8px; margin-top: 24px;">
                                        <button class="btn btn-primary" onclick="app.saveCurrentValidation()">
                                            ðŸ’¾ Save Changes
                                        </button>
                                        <button class="btn btn-danger" onclick="app.deleteCurrentValidation()">
                                            ðŸ—‘ï¸ Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                container.innerHTML = html;
            },

            updateYAMLEditor() {
                if (this.isSyncing) return;

                // Phase 2: Increment sync token to prevent race conditions
                this.syncToken = (this.syncToken || 0) + 1;
                const currentToken = this.syncToken;

                this.isSyncing = true;
                const yaml = this.generateYAML();

                // Only update if token hasn't changed (no newer sync started)
                if (this.monacoEditor && this.syncToken === currentToken) {
                    this.monacoEditor.setValue(yaml);
                } else if (this.syncToken === currentToken) {
                    document.getElementById('yaml-textarea').value = yaml;
                }

                // Use setTimeout to ensure Monaco has finished processing
                setTimeout(() => {
                    if (this.syncToken === currentToken) {
                        this.isSyncing = false;
                    }
                }, 0);
            },

            updateValidationSummary() {
                const summary = document.getElementById('validation-summary');

                // Check if element exists before setting content
                if (!summary) return;

                if (this.config.validation_job.name === '') {
                    summary.textContent = 'No project loaded';
                    return;
                }

                const fileCount = this.config.files.length;
                let validationCount = 0;
                this.config.files.forEach(file => {
                    validationCount += file.validations ? file.validations.length : 0;
                });

                summary.textContent = `Project: ${this.config.validation_job.name} | ${fileCount} file(s) | ${validationCount} validation(s)`;
            },

            updateHelpPanel() {
                const container = document.getElementById('help-content');

                if (this.selectedFile !== null && this.selectedValidation !== null) {
                    const file = this.config.files[this.selectedFile];
                    const validation = file.validations[this.selectedValidation];
                    const valDef = this.validationLibrary[validation.type];

                    if (valDef) {
                        container.innerHTML = `
                            <div class="help-section">
                                <h4>${valDef.icon} ${valDef.name}</h4>
                                <p>${valDef.description}</p>
                            </div>
                            <div class="help-section">
                                <h4>Category</h4>
                                <p>${valDef.category}</p>
                            </div>
                            <div class="help-section">
                                <h4>Common Use Cases</h4>
                                <p>${valDef.examples}</p>
                            </div>
                            <div class="help-section">
                                <h4>Tips</h4>
                                <p>${valDef.tips}</p>
                            </div>
                            <div class="help-section">
                                <h4>YAML Example</h4>
                                <div class="help-code">type: ${valDef.type}
severity: ERROR
params:
  # Configure parameters</div>
                            </div>
                        `;
                        return;
                    }
                }

                // Default help content
                container.innerHTML = `
                    <div class="help-section">
                        <h4>Welcome to DataK9 Studio</h4>
                        <p>Your professional IDE for building data validation configurations.</p>
                    </div>
                    <div class="help-section">
                        <h4>Quick Tips</h4>
                        <ul>
                            <li>Use ERROR severity for critical data requirements</li>
                            <li>Use WARNING severity for data quality issues</li>
                            <li>All validations support conditional execution</li>
                            <li>Changes are auto-saved to localStorage</li>
                        </ul>
                    </div>
                    <div class="help-section">
                        <h4>Keyboard Shortcuts</h4>
                        <ul>
                            <li>Ctrl+S - Export YAML (Project)</li>
                            <li>Ctrl+R - Sync from YAML</li>
                            <li>Ctrl+N - New project</li>
                            <li>Ctrl+O - Import YAML</li>
                        </ul>
                    </div>
                `;
            },

            /* ====================================================================
               YAML Generation
               ==================================================================== */

            generateYAML() {
                // Generate YAML string from config object
                // Note: This is a simplified YAML generator
                // For production, consider using a proper YAML library

                let yaml = '';

                // Validation Job section
                yaml += 'validation_job:\n';
                yaml += `  name: "${this.config.validation_job.name}"\n`;
                if (this.config.validation_job.description) {
                    yaml += `  description: "${this.config.validation_job.description}"\n`;
                }
                yaml += '\n';

                // Settings section (under validation_job)
                yaml += '  settings:\n';
                const settings = this.config.settings || this.config.validation_job.settings || {};
                yaml += `    chunk_size: ${settings.chunk_size || 50000}\n`;
                yaml += `    max_sample_failures: ${settings.max_sample_failures || 100}\n`;
                yaml += `    fail_on_error: ${settings.fail_on_error !== false}\n`;
                yaml += `    fail_on_warning: ${settings.fail_on_warning === true}\n`;
                yaml += `    log_level: "${settings.log_level || 'INFO'}"\n`;
                yaml += '\n';

                // Files section (under validation_job)
                yaml += '  files:\n';
                if (this.config.files.length === 0) {
                    yaml += '    []\n';
                } else {
                    this.config.files.forEach(file => {
                        yaml += `    - name: "${file.name}"\n`;
                        yaml += `      path: "${file.path}"\n`;
                        yaml += `      format: "${file.format}"\n`;
                        yaml += `      validations:\n`;

                        if (!file.validations || file.validations.length === 0) {
                            yaml += '        []\n';
                        } else {
                            file.validations.forEach(validation => {
                                yaml += `        - type: "${validation.type}"\n`;
                                yaml += `          severity: "${validation.severity || 'ERROR'}"\n`;

                                if (validation.params && Object.keys(validation.params).length > 0) {
                                    yaml += `          params:\n`;
                                    for (const [key, value] of Object.entries(validation.params)) {
                                        if (value === undefined || value === null || value === '') continue;

                                        if (typeof value === 'boolean') {
                                            yaml += `            ${key}: ${value}\n`;
                                        } else if (typeof value === 'number') {
                                            yaml += `            ${key}: ${value}\n`;
                                        } else if (typeof value === 'string') {
                                            // Handle comma-separated values as arrays
                                            if (value.includes(',') && (key.includes('fields') || key.includes('columns') || key.includes('files'))) {
                                                const items = value.split(',').map(v => v.trim()).filter(v => v);
                                                yaml += `            ${key}:\n`;
                                                items.forEach(item => {
                                                    yaml += `              - "${item}"\n`;
                                                });
                                            } else {
                                                yaml += `            ${key}: "${value}"\n`;
                                            }
                                        }
                                    }
                                }

                                if (validation.condition) {
                                    yaml += `          condition: "${validation.condition}"\n`;
                                }
                            });
                        }
                    });
                }

                return yaml;
            },

            /* ====================================================================
               YAML Parsing (Import)
               ==================================================================== */
            // NOTE: syncFromYAML() function is defined later in the file (line ~5964)
            // with full YAML parsing implementation

            /* ====================================================================
               Project Management
               ==================================================================== */

            startNewProject() {
                // Phase 3: Check for unsaved changes before starting new project
                if (!this.checkUnsavedChanges('start a new project')) {
                    return;
                }

                this.openModal('new-project-modal');
                this.wizardStep = 1;
                this.updateWizardUI();
            },

            /**
             * Close current project and return to welcome screen
             */
            closeProject() {
                // Check if there's a project open
                if (!this.projectState.isOpen) {
                    alert('No project is currently open.');
                    return;
                }

                // Check for export status
                if (!this.projectState.hasExportedYAML) {
                    // Never exported
                    const choice = confirm(
                        'This project has never been exported.\n\n' +
                        'Export YAML before closing?\n\n' +
                        'OK = Export, Cancel = Close without exporting'
                    );
                    if (choice) {
                        this.exportYAML();
                        // Return early - user can close manually after export
                        return;
                    }
                } else if (this.projectState.lastModified && this.projectState.lastModified > this.projectState.lastExported) {
                    // Changes since last export
                    const choice = confirm(
                        'You have changes since last export.\n\n' +
                        'Export updated YAML?\n\n' +
                        'OK = Export, Cancel = Close without exporting'
                    );
                    if (choice) {
                        this.exportYAML();
                        // Return early - user can close manually after export
                        return;
                    }
                }

                // Reset to initial state - use same structure as initialization
                this.config = {
                    validation_job: {
                        name: '',
                        description: '',
                        settings: {}
                    },
                    files: []
                };

                // Reset project state FIRST before any UI updates
                this.projectState = {
                    isOpen: false,
                    hasExportedYAML: false,
                    lastExported: null,
                    lastModified: null,
                    projectFileName: null
                };

                // Reset UI state
                this.selectedFile = null;
                this.selectedValidation = null;
                this.projectSettingsExpanded = false;

                // Clear localStorage (use correct key names with hyphens)
                localStorage.removeItem('datak9-config');
                localStorage.removeItem('datak9-project-state');
                localStorage.removeItem('datak9-panel-state');

                // Clear Monaco editor explicitly
                if (this.monacoEditor) {
                    this.monacoEditor.setValue('');
                }

                // Clear any selected panels before rendering
                const filePanel = document.getElementById('file-panel');
                const validationPanel = document.getElementById('validation-panel');
                if (filePanel) {
                    filePanel.innerHTML = '<div class="panel-placeholder">Select a file to configure</div>';
                }
                if (validationPanel) {
                    validationPanel.innerHTML = '<div class="panel-placeholder">Select a validation to configure</div>';
                }

                // Show welcome screen and hide editor BEFORE render
                const welcomeScreen = document.getElementById('welcome-screen');
                const editorView = document.getElementById('editor-view');
                if (welcomeScreen) {
                    welcomeScreen.classList.remove('hidden');
                }
                if (editorView) {
                    editorView.classList.add('hidden');
                }

                // Now render all UI components - this will respect projectState.isOpen = false
                this.render();

                // Show notification
                this.showNotification('Project closed - Ready to start new project or open existing YAML', 'info');
            },

            wizardNext() {
                // Validate current step before proceeding
                if (this.wizardStep === 1) {
                    // Step 1: Validate project name is filled
                    const projectName = document.getElementById('wizard-project-name').value.trim();
                    if (!projectName) {
                        alert('Please enter a project name before continuing.');
                        document.getElementById('wizard-project-name').focus();
                        return;
                    }
                    if (projectName.length > 100) {
                        alert('Project name must be 100 characters or less.');
                        document.getElementById('wizard-project-name').focus();
                        return;
                    }
                } else if (this.wizardStep === 3) {
                    // Step 3: Validate file details
                    const fileName = document.getElementById('wizard-file-name').value.trim();
                    const filePath = document.getElementById('wizard-file-path').value.trim();
                    const fileFormat = document.getElementById('wizard-file-format').value;

                    if (!fileName) {
                        alert('Please enter a file name before continuing.');
                        document.getElementById('wizard-file-name').focus();
                        return;
                    }
                    if (!filePath) {
                        alert('Please enter a file path before continuing.');
                        document.getElementById('wizard-file-path').focus();
                        return;
                    }
                    if (!fileFormat) {
                        alert('Please select a file format before continuing.');
                        document.getElementById('wizard-file-format').focus();
                        return;
                    }
                }

                if (this.wizardStep < 3) {
                    this.wizardStep++;
                    this.updateWizardUI();
                }
            },

            wizardBack() {
                if (this.wizardStep > 1) {
                    this.wizardStep--;
                    this.updateWizardUI();
                }
            },

            updateWizardUI() {
                // Update step indicators
                document.querySelectorAll('.wizard-step').forEach((step, index) => {
                    const stepNum = index + 1;
                    step.classList.remove('active', 'completed');
                    if (stepNum < this.wizardStep) {
                        step.classList.add('completed');
                    } else if (stepNum === this.wizardStep) {
                        step.classList.add('active');
                    }
                });

                // Show/hide step content
                for (let i = 1; i <= 3; i++) {
                    const content = document.getElementById(`wizard-step-${i}`);
                    content.classList.toggle('hidden', i !== this.wizardStep);
                }

                // Update buttons
                document.getElementById('wizard-back-btn').style.display = this.wizardStep > 1 ? 'inline-flex' : 'none';
                document.getElementById('wizard-next-btn').style.display = this.wizardStep < 3 ? 'inline-flex' : 'none';
                document.getElementById('wizard-finish-btn').style.display = this.wizardStep === 3 ? 'inline-flex' : 'none';
            },

            wizardFinish() {
                // Phase 3: Validate wizard inputs
                const projectName = document.getElementById('wizard-project-name').value.trim();
                const projectDescription = document.getElementById('wizard-project-description').value.trim();

                if (!projectName) {
                    alert('Project name is required');
                    return;
                }

                if (projectName.length > 100) {
                    alert('Project name must be 100 characters or less');
                    return;
                }

                const chunkSize = parseInt(document.getElementById('wizard-chunk-size').value);
                if (isNaN(chunkSize) || chunkSize < 1000 || chunkSize > 1000000) {
                    alert('Chunk size must be between 1,000 and 1,000,000');
                    return;
                }

                const maxFailures = parseInt(document.getElementById('wizard-max-failures').value);
                if (isNaN(maxFailures) || maxFailures < 1 || maxFailures > 10000) {
                    alert('Max sample failures must be between 1 and 10,000');
                    return;
                }

                // Collect data from wizard
                this.config.validation_job.name = projectName;
                this.config.validation_job.description = projectDescription;

                this.config.settings.chunk_size = chunkSize;
                this.config.settings.max_sample_failures = maxFailures;
                this.config.settings.fail_on_error = document.getElementById('wizard-fail-error').checked;
                this.config.settings.fail_on_warning = document.getElementById('wizard-fail-warning').checked;
                this.config.settings.log_level = document.getElementById('wizard-log-level').value;

                const fileName = document.getElementById('wizard-file-name').value.trim();
                const filePath = document.getElementById('wizard-file-path').value.trim();
                const fileFormat = document.getElementById('wizard-file-format').value;

                if (fileName && filePath) {
                    if (fileName.length > 100 || filePath.length > 500) {
                        alert('File name (max 100 chars) or path (max 500 chars) too long');
                        return;
                    }

                    this.config.files.push({
                        name: fileName,
                        path: filePath,
                        format: fileFormat,
                        validations: []
                    });
                }

                this.closeModal('new-project-modal');

                // Phase 3: Mark project as open and saved
                this.updateProjectState(true, null);  // null = new project, not from file
                this.markSaved();  // Wizard creates saved state

                this.saveToLocalStorage();
                this.render();
            },

            /**
             * Update wizard recommendations based on file size and format
             */
            updateWizardRecommendations() {
                const fileSizeInput = document.getElementById('wizard-file-size');
                const fileFormatSelect = document.getElementById('wizard-file-format');
                const recommendationsDiv = document.getElementById('wizard-recommendations');

                if (!fileSizeInput || !fileFormatSelect || !recommendationsDiv) {
                    return;
                }

                const fileSizeMB = parseFloat(fileSizeInput.value);
                const fileFormat = fileFormatSelect.value;

                // Hide recommendations if no file size entered
                if (!fileSizeMB || fileSizeMB <= 0) {
                    recommendationsDiv.style.display = 'none';
                    return;
                }

                // Show recommendations
                recommendationsDiv.style.display = 'block';

                // Calculate chunk size (using 10 as default estimated validations)
                const chunkCalc = this.calculateChunkSize(fileSizeMB, fileFormat, 10);

                // Check for Parquet recommendation
                const parquetRec = this.shouldRecommendParquet(fileSizeMB, fileFormat);

                // Build recommendations HTML
                let html = '<div style="font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">ðŸ“Š Performance Recommendations</div>';

                // Chunk size recommendation
                html += '<div style="margin-bottom: 12px;">';
                html += '<div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;">Recommended Chunk Size</div>';
                html += `<div style="font-size: 13px; color: var(--text-secondary);">${chunkCalc.chunk_size.toLocaleString()} rows</div>`;
                html += `<div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">Estimated: ${chunkCalc.estimated_rows.toLocaleString()} total rows in ${chunkCalc.num_chunks} chunks</div>`;
                html += '</div>';

                // Parquet recommendation
                if (parquetRec) {
                    const icon = parquetRec.level === 'warning' ? 'âš ï¸' : parquetRec.level === 'info' ? 'â„¹ï¸' : 'ðŸ’¡';
                    const colorClass = parquetRec.level === 'warning' ? 'color: var(--color-warning)' :
                                      parquetRec.level === 'info' ? 'color: var(--color-info)' :
                                      'color: var(--color-success)';
                    html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">';
                    html += `<div style="font-weight: 600; margin-bottom: 4px; font-size: 13px; ${colorClass};">${icon} ${parquetRec.level === 'warning' ? 'Performance Warning' : 'Tip'}</div>`;
                    html += `<div style="font-size: 13px; color: var(--text-secondary);">${parquetRec.recommendation}</div>`;
                    html += '</div>';
                }

                recommendationsDiv.innerHTML = html;
            },

            /* ====================================================================
               File Management
               ==================================================================== */

            /**
             * Calculate optimal chunk size based on file characteristics
             * JavaScript port of chunk_size_calculator.py logic
             */
            calculateChunkSize(fileSizeMB, fileFormat, numValidations = 10) {
                // Constants from Python implementation
                const BYTES_PER_ROW = {
                    'csv': 150,
                    'parquet': 50,
                    'json': 200,
                    'excel': 100
                };

                const VALIDATION_COMPLEXITY = {
                    'simple': 1.0,
                    'moderate': 2.0,
                    'complex': 4.0,
                    'heavy': 8.0
                };

                // Estimate available memory (assume 70% of 8GB = 5.6GB for safety)
                const availableMemoryMB = 5600;
                const targetMemoryMB = availableMemoryMB * 0.7;

                // Estimate row count
                const bytesPerRow = BYTES_PER_ROW[fileFormat] || 100;
                const estimatedRows = (fileSizeMB * 1024 * 1024) / bytesPerRow;

                // Determine complexity based on validation count
                let complexity = 'simple';
                if (numValidations > 20) complexity = 'heavy';
                else if (numValidations > 15) complexity = 'complex';
                else if (numValidations > 5) complexity = 'moderate';

                const complexityFactor = VALIDATION_COMPLEXITY[complexity];

                // Calculate memory per row with expansion (3x for pandas) and validation overhead
                let memoryPerRow = bytesPerRow * 3.0 * complexityFactor;
                memoryPerRow *= (1 + (numValidations * 0.1));

                // Calculate optimal chunk size
                const targetMemoryBytes = targetMemoryMB * 1024 * 1024;
                let optimalChunkSize = Math.floor(targetMemoryBytes / memoryPerRow);

                // Apply bounds: 10K min, 2M max
                optimalChunkSize = Math.max(10000, Math.min(optimalChunkSize, 2000000));

                // Calculate estimated chunks
                const estimatedChunks = Math.ceil(estimatedRows / optimalChunkSize);

                return {
                    recommendedChunkSize: optimalChunkSize,
                    estimatedRows: Math.floor(estimatedRows),
                    estimatedChunks: estimatedChunks,
                    complexity: complexity
                };
            },

            /**
             * Check if Parquet format is recommended
             * JavaScript port of performance_advisor.py logic
             */
            shouldRecommendParquet(fileSizeMB, fileFormat) {
                if (fileFormat !== 'csv') return null;

                if (fileSizeMB >= 5000) {
                    return {
                        level: 'warning',
                        message: `Very large CSV file (${fileSizeMB.toFixed(1)} MB)`,
                        recommendation: 'Strongly recommend converting to Parquet format',
                        benefit: '10x faster processing, 70% less memory usage'
                    };
                } else if (fileSizeMB >= 1000) {
                    return {
                        level: 'info',
                        message: `Large CSV file (${fileSizeMB.toFixed(1)} MB)`,
                        recommendation: 'Consider converting to Parquet format',
                        benefit: '3-10x faster processing, significant memory savings'
                    };
                } else if (fileSizeMB >= 100) {
                    return {
                        level: 'tip',
                        message: `CSV file is ${fileSizeMB.toFixed(1)} MB`,
                        recommendation: 'Parquet format recommended for better performance',
                        benefit: 'Faster processing and lower memory usage'
                    };
                }

                return null;
            },

            /**
             * Update file recommendations based on user input
             */
            updateFileRecommendations() {
                const fileSizeInput = document.getElementById('add-file-size');
                const fileFormatSelect = document.getElementById('add-file-format');
                const recommendationsDiv = document.getElementById('file-recommendations');

                if (!fileSizeInput || !fileFormatSelect || !recommendationsDiv) return;

                const fileSizeMB = parseFloat(fileSizeInput.value);
                const fileFormat = fileFormatSelect.value;

                // Hide if no file size specified
                if (!fileSizeMB || fileSizeMB <= 0) {
                    recommendationsDiv.style.display = 'none';
                    return;
                }

                let html = '';

                // Check for Parquet recommendation
                const parquetRec = this.shouldRecommendParquet(fileSizeMB, fileFormat);
                if (parquetRec) {
                    const icon = parquetRec.level === 'warning' ? 'âš ï¸' : parquetRec.level === 'info' ? 'â„¹ï¸' : 'ðŸ’¡';
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<div style="font-weight: 600; margin-bottom: 4px;">${icon} ${parquetRec.message}</div>`;
                    html += `<div style="font-size: 13px; color: var(--text-secondary);">${parquetRec.recommendation}</div>`;
                    html += `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Benefit: ${parquetRec.benefit}</div>`;
                    html += `</div>`;
                }

                // Calculate chunk size
                const numValidations = this.config.files.length > 0 ?
                    this.config.files[0].validations?.length || 10 : 10;
                const chunkCalc = this.calculateChunkSize(fileSizeMB, fileFormat, numValidations);

                // Update the chunk size input field with calculated value
                const chunkSizeInput = document.getElementById('wizard-chunk-size');
                if (chunkSizeInput) {
                    chunkSizeInput.value = chunkCalc.recommendedChunkSize;
                }

                html += `<div style="border-top: 1px solid var(--border); padding-top: 12px;">`;
                html += `<div style="font-weight: 600; margin-bottom: 6px;">ðŸ“Š Recommended Chunk Size</div>`;
                html += `<div style="font-size: 14px; color: var(--text-primary);">${chunkCalc.recommendedChunkSize.toLocaleString()} rows/chunk</div>`;
                html += `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">`;
                html += `Est. ${chunkCalc.estimatedRows.toLocaleString()} rows in ${chunkCalc.estimatedChunks} chunks (${chunkCalc.complexity} complexity)`;
                html += `</div>`;
                html += `</div>`;

                recommendationsDiv.innerHTML = html;
                recommendationsDiv.style.display = 'block';
            },

            selectFile(index) {
                this.selectedFile = index;
                this.selectedValidation = null;
                this.render();
            },

            addFile() {
                // Phase 3: Require project to be open before adding files
                if (!this.requireProject('adding files')) {
                    return;
                }

                this.openModal('add-file-modal');
                document.getElementById('add-file-name').value = '';
                document.getElementById('add-file-path').value = '';
                document.getElementById('add-file-format').value = 'csv';
                document.getElementById('add-file-size').value = '';

                // Hide recommendations initially
                const recsEl = document.getElementById('file-recommendations');
                if (recsEl) {
                    recsEl.style.display = 'none';
                }
            },

            saveNewFile() {
                const name = document.getElementById('add-file-name').value.trim();
                const path = document.getElementById('add-file-path').value.trim();
                const format = document.getElementById('add-file-format').value;

                // Phase 3: Comprehensive input validation
                if (!name || !path) {
                    alert('Please provide both file name and path');
                    return;
                }

                if (name.length > 100) {
                    alert('File name must be 100 characters or less');
                    return;
                }

                if (path.length > 500) {
                    alert('File path must be 500 characters or less');
                    return;
                }

                // Ensure config.files array exists
                if (!this.config.files) {
                    this.config.files = [];
                }

                // Check for duplicate file names
                if (this.config.files.some(f => f.name === name)) {
                    alert('A file with this name already exists. Please use a different name.');
                    return;
                }

                this.config.files.push({
                    name: name,
                    path: path,
                    format: format,
                    validations: []
                });

                // Clear input fields for next time
                document.getElementById('add-file-name').value = '';
                document.getElementById('add-file-path').value = '';
                document.getElementById('add-file-format').value = 'csv';

                this.closeModal('add-file-modal');
                this.updateYAMLEditor();  // Update YAML to reflect new file
                this.markAsModified();    // Mark as modified
                this.saveToLocalStorage();
                this.render();

                this.showNotification(`File "${name}" added successfully`, 'success');
            },

            deleteFile(index) {
                if (confirm('Are you sure you want to delete this file?')) {
                    this.config.files.splice(index, 1);
                    if (this.selectedFile === index) {
                        this.selectedFile = null;
                        this.selectedValidation = null;
                    }
                    this.saveToLocalStorage();
                    this.render();
                }
            },

            updateFileName(index, value) {
                this.config.files[index].name = value;
                this.saveToLocalStorage();
                this.render();
            },

            updateFilePath(index, value) {
                this.config.files[index].path = value;
                this.saveToLocalStorage();
                this.render();
            },

            updateFileFormat(index, value) {
                this.config.files[index].format = value;
                this.saveToLocalStorage();
                this.render();
            },

            /* ====================================================================
               Validation Management
               ==================================================================== */

            selectValidation(fileIndex, valIndex) {
                this.selectedFile = fileIndex;
                this.selectedValidation = valIndex;
                this.render();
            },

            addValidationToFile(fileIndex) {
                this.selectedFile = fileIndex;
                this.openAddValidationDialog();
            },

            openAddValidationDialog() {
                this.openModal('add-validation-modal');
                this.renderValidationCatalog('add-validation');
            },

            renderValidationCatalog(prefix) {
                const categoriesEl = document.getElementById(`${prefix}-categories`);
                const listEl = document.getElementById(`${prefix}-list`);

                // Get unique categories
                const categories = [...new Set(Object.values(this.validationLibrary).map(v => v.category))];

                // Render category filters
                let catHTML = '<div class="category-filter active" onclick="app.filterCatalogCategory(\'' + prefix + '\', null)">All</div>';
                categories.forEach(cat => {
                    catHTML += `<div class="category-filter" onclick="app.filterCatalogCategory('${prefix}', '${cat}')">${cat}</div>`;
                });
                categoriesEl.innerHTML = catHTML;

                // Render validation items
                let itemsHTML = '';
                Object.entries(this.validationLibrary).forEach(([key, val]) => {
                    itemsHTML += `
                        <div class="validation-catalog-item" data-category="${val.category}" data-name="${val.name.toLowerCase()}"
                             onclick="app.selectValidationFromCatalog('${key}')">
                            <div class="validation-catalog-header">
                                <span class="validation-catalog-icon">${val.icon}</span>
                                <span class="validation-catalog-name">${val.name}</span>
                            </div>
                            <div class="validation-catalog-description">${val.description}</div>
                            <span class="validation-catalog-category">${val.category}</span>
                        </div>
                    `;
                });
                listEl.innerHTML = itemsHTML;
            },

            filterCatalogCategory(prefix, category) {
                // Update active state
                document.querySelectorAll(`#${prefix}-categories .category-filter`).forEach(el => {
                    el.classList.remove('active');
                });
                event.target.classList.add('active');

                // Filter items
                const items = document.querySelectorAll(`#${prefix}-list .validation-catalog-item`);
                items.forEach(item => {
                    if (!category || item.dataset.category === category) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            },

            filterCatalog() {
                const search = document.getElementById('catalog-search').value.toLowerCase();
                const items = document.querySelectorAll('#catalog-list .validation-catalog-item');
                items.forEach(item => {
                    if (item.dataset.name.includes(search)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            },

            filterAddValidation() {
                const search = document.getElementById('add-validation-search').value.toLowerCase();
                const items = document.querySelectorAll('#add-validation-list .validation-catalog-item');
                items.forEach(item => {
                    if (item.dataset.name.includes(search)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            },

            selectValidationFromCatalog(validationType) {
                if (this.selectedFile === null) {
                    alert('Please select a file first');
                    return;
                }

                const file = this.config.files[this.selectedFile];
                if (!file.validations) {
                    file.validations = [];
                }

                file.validations.push({
                    type: validationType,
                    severity: 'ERROR',
                    params: {}
                });

                this.selectedValidation = file.validations.length - 1;
                this.closeModal('add-validation-modal');
                this.saveToLocalStorage();
                this.render();
            },

            saveCurrentValidation() {
                if (this.selectedFile === null || this.selectedValidation === null) return;

                const file = this.config.files[this.selectedFile];
                const validation = file.validations[this.selectedValidation];
                const valDef = this.validationLibrary[validation.type];

                // Update severity
                validation.severity = document.getElementById('edit-severity').value;

                // Update params
                validation.params = {};
                valDef.params.forEach(param => {
                    const el = document.getElementById(`edit-param-${param.name}`);
                    if (el) {
                        if (param.type === 'checkbox') {
                            validation.params[param.name] = el.checked;
                        } else if (param.type === 'number') {
                            const val = el.value;
                            if (val !== '') {
                                validation.params[param.name] = parseFloat(val);
                            }
                        } else {
                            const val = el.value;
                            if (val !== '') {
                                validation.params[param.name] = val;
                            }
                        }
                    }
                });

                // Update condition
                const condition = document.getElementById('edit-condition').value;
                if (condition) {
                    validation.condition = condition;
                } else {
                    delete validation.condition;
                }

                this.saveToLocalStorage();
                this.render();
            },

            deleteCurrentValidation() {
                if (this.selectedFile === null || this.selectedValidation === null) return;

                if (confirm('Are you sure you want to delete this validation?')) {
                    const file = this.config.files[this.selectedFile];
                    file.validations.splice(this.selectedValidation, 1);
                    this.selectedValidation = null;
                    this.saveToLocalStorage();
                    this.render();
                }
            },

            /* ====================================================================
               Validation Reordering and Duplication
               ====================================================================

               These methods provide functionality to:
               - Duplicate validations (with deep copy of all parameters)
               - Move validations up and down within a file
               - Drag and drop reordering for validations
               - Context menu for quick actions
               - Touch support for mobile devices
            */

            /**
             * Duplicates a validation with all its parameters
             * Creates a deep copy to ensure no reference sharing
             * Inserts the duplicate immediately after the original
             * Auto-selects the duplicated validation for editing
             *
             * @param {number} fileIndex - Index of the file containing the validation
             * @param {number} validationIndex - Index of the validation to duplicate
             */
            duplicateValidation(fileIndex, validationIndex) {
                // Validate indices
                if (fileIndex < 0 || fileIndex >= this.config.files.length) {
                    console.error('Invalid file index:', fileIndex);
                    return;
                }

                const file = this.config.files[fileIndex];
                if (!file.validations || validationIndex < 0 || validationIndex >= file.validations.length) {
                    console.error('Invalid validation index:', validationIndex);
                    return;
                }

                // Get the validation to duplicate
                const originalValidation = file.validations[validationIndex];

                // Create a deep copy using JSON parse/stringify
                // This ensures all nested objects and arrays are properly copied
                const duplicatedValidation = JSON.parse(JSON.stringify(originalValidation));

                // Insert the duplicate immediately after the original
                file.validations.splice(validationIndex + 1, 0, duplicatedValidation);

                // Update the UI
                this.renderFileTree();

                // Select the duplicated validation
                this.selectedFile = fileIndex;
                this.selectedValidation = validationIndex + 1;

                // Update YAML and save state
                this.updateYAMLEditor();
                this.saveToLocalStorage();
                this.render();

                // Add pulse animation to the duplicated item
                setTimeout(() => {
                    const validationItems = document.querySelectorAll('.validation-item');
                    const duplicatedItem = validationItems[validationIndex + 1];
                    if (duplicatedItem) {
                        duplicatedItem.classList.add('just-duplicated');
                        // Scroll into view if needed
                        duplicatedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        // Remove animation class after animation completes
                        setTimeout(() => {
                            duplicatedItem.classList.remove('just-duplicated');
                        }, 600);
                    }
                }, 100);

                // Show success notification (if notification system exists)
                console.log('Validation duplicated successfully');
            },

            /**
             * Moves a validation up one position in the list
             * Updates YAML and saves state after move
             *
             * @param {number} fileIndex - Index of the file containing the validation
             * @param {number} validationIndex - Index of the validation to move
             */
            moveValidationUp(fileIndex, validationIndex) {
                // Can't move the first item up
                if (validationIndex <= 0) return;

                const file = this.config.files[fileIndex];
                if (!file.validations) return;

                // Swap with previous item
                const temp = file.validations[validationIndex];
                file.validations[validationIndex] = file.validations[validationIndex - 1];
                file.validations[validationIndex - 1] = temp;

                // Update selection to follow the moved item
                if (this.selectedFile === fileIndex && this.selectedValidation === validationIndex) {
                    this.selectedValidation = validationIndex - 1;
                }

                // Phase 3 & 4: Track changes and update
                this.markUnsavedChanges();
                this.updateYAMLEditor();
                this.saveToLocalStorage();
                this.render();
            },

            /**
             * Moves a validation down one position in the list
             * Updates YAML and saves state after move
             *
             * @param {number} fileIndex - Index of the file containing the validation
             * @param {number} validationIndex - Index of the validation to move
             */
            moveValidationDown(fileIndex, validationIndex) {
                const file = this.config.files[fileIndex];
                if (!file.validations) return;

                // Can't move the last item down
                if (validationIndex >= file.validations.length - 1) return;

                // Swap with next item
                const temp = file.validations[validationIndex];
                file.validations[validationIndex] = file.validations[validationIndex + 1];
                file.validations[validationIndex + 1] = temp;

                // Update selection to follow the moved item
                if (this.selectedFile === fileIndex && this.selectedValidation === validationIndex) {
                    this.selectedValidation = validationIndex + 1;
                }

                // Phase 3 & 4: Track changes and update
                this.markUnsavedChanges();
                this.updateYAMLEditor();
                this.saveToLocalStorage();
                this.render();
            },

            /* ====================================================================
               Drag and Drop - Validations
               ==================================================================== */

            /**
             * Handles the start of a validation drag operation
             * Stores drag state and adds visual feedback
             */
            handleValidationDragStart(event, fileIndex, validationIndex) {
                // Store drag data
                this.dragState = {
                    type: 'validation',
                    fileIndex: fileIndex,
                    validationIndex: validationIndex
                };

                // Set drag image (the element being dragged)
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/html', event.target.innerHTML);

                // Add dragging class for visual feedback
                event.target.classList.add('dragging');
            },

            /**
             * Handles drag over event for validations
             * Determines drop position and shows visual indicator
             */
            handleValidationDragOver(event) {
                event.preventDefault();
                event.stopPropagation();

                // Only allow validation drops
                if (!this.dragState || this.dragState.type !== 'validation') return;

                event.dataTransfer.dropEffect = 'move';

                // Get the target validation item
                const target = event.currentTarget;
                const rect = target.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;

                // Remove previous indicators
                document.querySelectorAll('.validation-item').forEach(item => {
                    item.classList.remove('drag-over-top', 'drag-over-bottom');
                });

                // Add indicator based on mouse position
                if (event.clientY < midpoint) {
                    target.classList.add('drag-over-top');
                } else {
                    target.classList.add('drag-over-bottom');
                }
            },

            /**
             * Handles drop event for validations
             * Performs the actual reordering
             */
            handleValidationDrop(event, targetFileIndex, targetValidationIndex) {
                event.preventDefault();
                event.stopPropagation();

                if (!this.dragState || this.dragState.type !== 'validation') return;

                const sourceFileIndex = this.dragState.fileIndex;
                const sourceValidationIndex = this.dragState.validationIndex;

                // Can only reorder within the same file
                if (sourceFileIndex !== targetFileIndex) return;

                // Don't do anything if dropping on itself
                if (sourceValidationIndex === targetValidationIndex) return;

                const file = this.config.files[sourceFileIndex];

                // Determine actual drop position based on visual indicator
                const target = event.currentTarget;
                const rect = target.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                let newIndex = targetValidationIndex;

                if (event.clientY >= midpoint) {
                    // Drop below target
                    newIndex = targetValidationIndex + 1;
                }

                // Adjust for removal of source item
                if (sourceValidationIndex < newIndex) {
                    newIndex--;
                }

                // Perform the move
                const validation = file.validations.splice(sourceValidationIndex, 1)[0];
                file.validations.splice(newIndex, 0, validation);

                // Update selection to follow moved item
                if (this.selectedFile === sourceFileIndex && this.selectedValidation === sourceValidationIndex) {
                    this.selectedValidation = newIndex;
                }

                // Update UI and save
                this.updateYAMLEditor();
                this.saveToLocalStorage();
                this.render();
            },

            /**
             * Handles the end of a validation drag operation
             * Cleans up visual feedback
             */
            handleValidationDragEnd(event) {
                // Remove visual feedback
                event.target.classList.remove('dragging');
                document.querySelectorAll('.validation-item').forEach(item => {
                    item.classList.remove('drag-over-top', 'drag-over-bottom');
                });

                // Clear drag state
                this.dragState = null;
            },

            /* ====================================================================
               Drag and Drop - Files
               ==================================================================== */

            /**
             * Handles the start of a file drag operation
             */
            handleFileDragStart(event, fileIndex) {
                this.dragState = {
                    type: 'file',
                    fileIndex: fileIndex
                };

                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/html', event.target.innerHTML);
                event.target.classList.add('dragging');
            },

            /**
             * Handles drag over event for files
             */
            handleFileDragOver(event) {
                event.preventDefault();
                event.stopPropagation();

                if (!this.dragState || this.dragState.type !== 'file') return;

                event.dataTransfer.dropEffect = 'move';

                const target = event.currentTarget;
                const rect = target.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;

                // Remove previous indicators
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('drag-over-top', 'drag-over-bottom');
                });

                // Add indicator based on mouse position
                if (event.clientY < midpoint) {
                    target.classList.add('drag-over-top');
                } else {
                    target.classList.add('drag-over-bottom');
                }
            },

            /**
             * Handles drop event for files
             */
            handleFileDrop(event, targetFileIndex) {
                event.preventDefault();
                event.stopPropagation();

                if (!this.dragState || this.dragState.type !== 'file') return;

                const sourceFileIndex = this.dragState.fileIndex;

                if (sourceFileIndex === targetFileIndex) return;

                // Determine drop position
                const target = event.currentTarget;
                const rect = target.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                let newIndex = targetFileIndex;

                if (event.clientY >= midpoint) {
                    newIndex = targetFileIndex + 1;
                }

                // Adjust for removal
                if (sourceFileIndex < newIndex) {
                    newIndex--;
                }

                // Perform the move
                const file = this.config.files.splice(sourceFileIndex, 1)[0];
                this.config.files.splice(newIndex, 0, file);

                // Update selection to follow moved file
                if (this.selectedFile === sourceFileIndex) {
                    this.selectedFile = newIndex;
                }

                // Update UI and save
                this.updateYAMLEditor();
                this.saveToLocalStorage();
                this.render();
            },

            /**
             * Handles the end of a file drag operation
             */
            handleFileDragEnd(event) {
                event.target.classList.remove('dragging');
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('drag-over-top', 'drag-over-bottom');
                });
                this.dragState = null;
            },

            /* ====================================================================
               Touch Support for Mobile Drag and Drop
               ==================================================================== */

            /**
             * Handles touch start for mobile drag
             */
            handleValidationTouchStart(event, fileIndex, validationIndex) {
                this.touchState = {
                    fileIndex: fileIndex,
                    validationIndex: validationIndex,
                    startY: event.touches[0].clientY,
                    element: event.currentTarget,
                    longPressTimer: setTimeout(() => {
                        // Long press detected - enter drag mode
                        this.touchState.dragging = true;
                        event.currentTarget.classList.add('dragging');
                        // Haptic feedback if available
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    }, 500) // 500ms long press
                };
            },

            /**
             * Handles touch move for mobile drag
             */
            handleValidationTouchMove(event) {
                if (!this.touchState) return;

                // Cancel long press if user moves too much before timer
                if (!this.touchState.dragging && this.touchState.longPressTimer) {
                    const deltaY = Math.abs(event.touches[0].clientY - this.touchState.startY);
                    if (deltaY > 10) {
                        clearTimeout(this.touchState.longPressTimer);
                        this.touchState = null;
                        return;
                    }
                }

                if (!this.touchState.dragging) return;

                event.preventDefault();

                // Find element under touch
                const touch = event.touches[0];
                const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
                const validationItem = elementUnder?.closest('.validation-item');

                if (validationItem && validationItem !== this.touchState.element) {
                    // Show drop indicator
                    document.querySelectorAll('.validation-item').forEach(item => {
                        item.classList.remove('drag-over-top', 'drag-over-bottom');
                    });

                    const rect = validationItem.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;

                    if (touch.clientY < midpoint) {
                        validationItem.classList.add('drag-over-top');
                    } else {
                        validationItem.classList.add('drag-over-bottom');
                    }

                    this.touchState.targetElement = validationItem;
                }
            },

            /**
             * Handles touch end for mobile drag
             */
            handleValidationTouchEnd(event) {
                if (!this.touchState) return;

                // Clear long press timer
                if (this.touchState.longPressTimer) {
                    clearTimeout(this.touchState.longPressTimer);
                }

                if (this.touchState.dragging && this.touchState.targetElement) {
                    // Perform drop
                    const sourceFileIndex = this.touchState.fileIndex;
                    const sourceValidationIndex = this.touchState.validationIndex;
                    const targetFileIndex = parseInt(this.touchState.targetElement.dataset.fileIndex);
                    const targetValidationIndex = parseInt(this.touchState.targetElement.dataset.validationIndex);

                    if (sourceFileIndex === targetFileIndex && sourceValidationIndex !== targetValidationIndex) {
                        const file = this.config.files[sourceFileIndex];
                        const validation = file.validations.splice(sourceValidationIndex, 1)[0];

                        let newIndex = targetValidationIndex;
                        if (sourceValidationIndex < newIndex) {
                            newIndex--;
                        }

                        file.validations.splice(newIndex, 0, validation);

                        this.updateYAMLEditor();
                        this.saveToLocalStorage();
                        this.render();
                    }
                }

                // Clean up
                if (this.touchState.element) {
                    this.touchState.element.classList.remove('dragging');
                }
                document.querySelectorAll('.validation-item').forEach(item => {
                    item.classList.remove('drag-over-top', 'drag-over-bottom');
                });
                this.touchState = null;
            },

            /* ====================================================================
               Context Menu
               ==================================================================== */

            /**
             * Shows context menu for validation items
             * Provides quick access to common actions
             */
            showValidationContextMenu(event, fileIndex, validationIndex) {
                event.preventDefault();
                event.stopPropagation();

                // Remove any existing context menu
                const existingMenu = document.querySelector('.context-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }

                const file = this.config.files[fileIndex];
                const isFirst = validationIndex === 0;
                const isLast = validationIndex === file.validations.length - 1;

                // Create context menu
                const menu = document.createElement('div');
                menu.className = 'context-menu';
                menu.style.top = event.clientY + 'px';
                menu.style.left = event.clientX + 'px';

                menu.innerHTML = `
                    <div class="context-menu-item ${isFirst ? 'disabled' : ''}"
                         onclick="${isFirst ? '' : `app.moveValidationUp(${fileIndex}, ${validationIndex}); this.closest('.context-menu').remove();`}">
                        â†‘ Move Up
                    </div>
                    <div class="context-menu-item ${isLast ? 'disabled' : ''}"
                         onclick="${isLast ? '' : `app.moveValidationDown(${fileIndex}, ${validationIndex}); this.closest('.context-menu').remove();`}">
                        â†“ Move Down
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item"
                         onclick="app.duplicateValidation(${fileIndex}, ${validationIndex}); this.closest('.context-menu').remove();">
                        ðŸ“‹ Duplicate
                    </div>
                    <div class="context-menu-item"
                         onclick="app.selectValidation(${fileIndex}, ${validationIndex}); this.closest('.context-menu').remove();">
                        âœï¸ Edit
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item danger"
                         onclick="if(confirm('Delete this validation?')) { app.config.files[${fileIndex}].validations.splice(${validationIndex}, 1); app.updateYAMLEditor(); app.saveToLocalStorage(); app.render(); } this.closest('.context-menu').remove();">
                        ðŸ—‘ï¸ Delete
                    </div>
                `;

                document.body.appendChild(menu);

                // Position adjustment if menu goes off screen
                const rect = menu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
                }

                // Close on click outside
                setTimeout(() => {
                    const closeMenu = (e) => {
                        if (!menu.contains(e.target)) {
                            menu.remove();
                            document.removeEventListener('click', closeMenu);
                        }
                    };
                    document.addEventListener('click', closeMenu);
                }, 100);
            },

            /* ====================================================================
               Import/Export
               ==================================================================== */

            /**
             * Open the unified Open Project dialog
             */
            openProjectDialog() {
                this.openModal('open-project-modal');
                // Clear paste textarea and reset to file tab
                document.getElementById('import-yaml-text').value = '';
                this.switchOpenMethod('file');
            },

            /**
             * Switch between file and paste methods in Open Project dialog
             */
            switchOpenMethod(method) {
                const fileTab = document.getElementById('open-from-file-tab');
                const pasteTab = document.getElementById('open-from-paste-tab');
                const fileSection = document.getElementById('open-from-file-section');
                const pasteSection = document.getElementById('open-from-paste-section');
                const actionBtn = document.getElementById('open-project-action-btn');

                if (method === 'file') {
                    // Activate file tab
                    fileTab.classList.add('active');
                    fileTab.style.borderBottom = '3px solid var(--k9-blue)';
                    fileTab.style.color = 'var(--k9-blue)';
                    pasteTab.classList.remove('active');
                    pasteTab.style.borderBottom = '3px solid transparent';
                    pasteTab.style.color = 'var(--text-secondary)';

                    // Show file section, hide paste section
                    fileSection.style.display = 'block';
                    pasteSection.style.display = 'none';

                    // Update action button
                    actionBtn.textContent = 'Open from File';
                    actionBtn.onclick = () => this.openProjectFromFile();
                } else {
                    // Activate paste tab
                    pasteTab.classList.add('active');
                    pasteTab.style.borderBottom = '3px solid var(--k9-blue)';
                    pasteTab.style.color = 'var(--k9-blue)';
                    fileTab.classList.remove('active');
                    fileTab.style.borderBottom = '3px solid transparent';
                    fileTab.style.color = 'var(--text-secondary)';

                    // Show paste section, hide file section
                    fileSection.style.display = 'none';
                    pasteSection.style.display = 'block';

                    // Update action button
                    actionBtn.textContent = 'Import YAML';
                    actionBtn.onclick = () => this.openProjectFromPaste();
                }
            },

            /**
             * Open project from file (triggered from modal)
             */
            openProjectFromFile() {
                // Trigger the hidden file input
                document.getElementById('open-file-input').click();
            },

            /**
             * Handle file selection from file input
             */
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const yamlContent = e.target.result;

                        // Parse YAML using our custom parser
                        const parsedConfig = this.parseYAML(yamlContent);

                        // Validate structure
                        if (!parsedConfig.validation_job) {
                            throw new Error("Missing required 'validation_job' key in YAML");
                        }

                        // Normalize structure
                        parsedConfig.files = parsedConfig.validation_job.files || [];

                        // Load the configuration
                        this.config = parsedConfig;

                        // Update project state
                        this.projectState.isOpen = true;
                        this.projectState.projectFileName = file.name;
                        this.projectState.lastModified = Date.now();
                        this.projectState.hasExportedYAML = false;

                        // Update UI
                        this.renderFileTree();
                        this.updateYAMLEditor();
                        this.updateStatusBar();

                        // Hide welcome screen, show editor
                        document.getElementById('welcome-screen').classList.add('hidden');
                        document.getElementById('editor-view').classList.remove('hidden');

                        // Save to localStorage
                        this.saveToLocalStorage();

                        // Close modal and show success
                        this.closeModal('open-project-modal');
                        this.showNotification(`âœ“ Opened ${file.name}`, 'success');

                    } catch (error) {
                        console.error('Error loading file:', error);
                        this.showYAMLError(error);
                    }
                };

                reader.onerror = () => {
                    alert('Error reading file. Please try again.');
                };

                reader.readAsText(file);

                // Reset file input
                event.target.value = '';
            },

            /**
             * Open project from pasted YAML
             */
            openProjectFromPaste() {
                const yamlText = document.getElementById('import-yaml-text').value.trim();

                if (!yamlText) {
                    alert('Please paste a YAML configuration.');
                    return;
                }

                try {
                    // Parse YAML using our custom parser
                    const parsedConfig = this.parseYAML(yamlText);

                    // Validate structure
                    if (!parsedConfig.validation_job) {
                        throw new Error("Missing required 'validation_job' key in YAML");
                    }

                    // Normalize structure
                    parsedConfig.files = parsedConfig.validation_job.files || [];

                    // Load the configuration
                    this.config = parsedConfig;

                    // Update project state
                    this.projectState.isOpen = true;
                    this.projectState.projectFileName = null; // No file, pasted content
                    this.projectState.lastModified = Date.now();
                    this.projectState.hasExportedYAML = false;

                    // Update UI
                    this.renderFileTree();
                    this.updateYAMLEditor();
                    this.updateStatusBar();

                    // Hide welcome screen, show editor
                    document.getElementById('welcome-screen').classList.add('hidden');
                    document.getElementById('editor-view').classList.remove('hidden');

                    // Save to localStorage
                    this.saveToLocalStorage();

                    // Close modal and show success
                    this.closeModal('open-project-modal');
                    this.showNotification('âœ“ Project loaded from YAML', 'success');

                } catch (error) {
                    console.error('Error parsing YAML:', error);
                    this.showYAMLError(error);
                }
            },

            exportYAML() {
                // Generate default filename from project name
                const projectName = this.config.validation_job?.name || 'validation';
                const defaultFilename = `${projectName.replace(/\s+/g, '_')}_config.yaml`;

                // Prompt user for filename
                const filename = prompt('Enter filename for YAML export:', defaultFilename);
                if (!filename) return; // User cancelled

                // Ensure .yaml extension
                const finalFilename = filename.endsWith('.yaml') || filename.endsWith('.yml')
                    ? filename
                    : `${filename}.yaml`;

                // Export file
                const yaml = this.generateYAML();
                const blob = new Blob([yaml], { type: 'text/yaml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = finalFilename;
                a.click();
                URL.revokeObjectURL(url);

                // Update export state
                const now = Date.now();
                this.projectState.hasExportedYAML = true;
                this.projectState.lastExported = now;
                this.projectState.projectFileName = finalFilename;

                // Update status bar
                this.updateStatusBar();

                // Show success notification
                this.showNotification(`âœ“ Exported as ${finalFilename}`, 'success');
            },

            copyYAML() {
                const yaml = this.generateYAML();

                // Check if clipboard API is available
                if (!navigator.clipboard || !navigator.clipboard.writeText) {
                    // Fallback for browsers without clipboard API or non-HTTPS contexts
                    const textArea = document.createElement('textarea');
                    textArea.value = yaml;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert('YAML copied to clipboard!');
                    } catch (err) {
                        console.error('Failed to copy:', err);
                        alert('Failed to copy. Please manually copy from the YAML editor.');
                    }
                    document.body.removeChild(textArea);
                    return;
                }

                // Use modern clipboard API
                navigator.clipboard.writeText(yaml)
                    .then(() => {
                        alert('YAML copied to clipboard!');
                    })
                    .catch(err => {
                        console.error('Failed to copy to clipboard:', err);
                        alert('Failed to copy to clipboard. Please copy manually from the YAML editor.');
                    });
            },

            formatYAML() {
                // Regenerate YAML (already formatted)
                this.updateYAMLEditor();
            },

            /**
             * Toggle YAML editor lock/unlock
             * When locked: YAML is read-only and synced from UI
             * When unlocked: YAML can be edited, changes stay in editor until locked again
             */
            toggleYAMLLock() {
                if (!this.monacoEditor) return;

                const isCurrentlyLocked = this.monacoEditor.getOption(monaco.editor.EditorOption.readOnly);
                const lockBtn = document.getElementById('yaml-lock-btn');

                if (isCurrentlyLocked) {
                    // Unlock: Allow editing
                    this.monacoEditor.updateOptions({ readOnly: false });
                    lockBtn.innerHTML = 'ðŸ”“ Lock & Reload';
                    lockBtn.classList.remove('btn-secondary');
                    lockBtn.classList.add('btn-warning');
                    lockBtn.title = 'Lock editor and reload YAML from UI state';
                    console.log('YAML editor unlocked - you can now edit');
                } else {
                    // Lock: Sync from YAML to UI, then reload YAML from UI
                    try {
                        // First, sync any edits from YAML to UI
                        this.syncFromYAML();

                        // Then reload YAML from the UI state (this ensures consistency)
                        this.updateYAMLEditor();

                        // Save to localStorage
                        this.saveToLocalStorage();

                        // Now lock the editor
                        this.monacoEditor.updateOptions({ readOnly: true });
                        lockBtn.innerHTML = 'ðŸ”’ Unlock to Edit';
                        lockBtn.classList.remove('btn-warning');
                        lockBtn.classList.add('btn-secondary');
                        lockBtn.title = 'Unlock to edit YAML directly';

                        console.log('YAML editor locked - changes applied and YAML reloaded from UI');
                    } catch (error) {
                        alert('Error applying YAML changes: ' + error.message);
                        console.error('Error in lock workflow:', error);
                    }
                }
            },

            /**
             * Sync YAML changes back to the UI
             * Parses YAML from editor and rebuilds the config and UI
             */
            syncFromYAML() {
                try {
                    // Get YAML content from Monaco editor or fallback textarea
                    const yamlContent = this.monacoEditor
                        ? this.monacoEditor.getValue()
                        : document.getElementById('yaml-textarea').value;

                    // Parse YAML to config object
                    const parsedConfig = this.parseYAML(yamlContent);

                    // Validate structure
                    if (!parsedConfig.validation_job) {
                        throw new Error("Missing required 'validation_job' key in YAML");
                    }

                    // Normalize structure: Move files and settings to top level for internal use
                    // The app expects this.config.files, not this.config.validation_job.files
                    parsedConfig.files = parsedConfig.validation_job.files || [];

                    // The app expects this.config.settings, not this.config.validation_job.settings
                    // Keep both in sync for bi-directional updates
                    if (parsedConfig.validation_job.settings) {
                        parsedConfig.settings = parsedConfig.validation_job.settings;
                    } else {
                        // Ensure settings object exists with defaults
                        parsedConfig.settings = {
                            chunk_size: 50000,
                            max_sample_failures: 100,
                            fail_on_error: true,
                            fail_on_warning: false,
                            log_level: 'INFO'
                        };
                        // Also set in validation_job for YAML generation
                        parsedConfig.validation_job.settings = parsedConfig.settings;
                    }

                    // Update internal config
                    this.config = parsedConfig;

                    // Mark project as open if it has a name or files
                    if (parsedConfig.validation_job.name || parsedConfig.files.length > 0) {
                        this.updateProjectState(true, null);
                    }

                    // Mark as having unsaved changes
                    this.projectState.hasUnsavedChanges = true;

                    // Rebuild UI components
                    this.renderFileTree();
                    this.updateStatusBar();

                    // Show success notification
                    this.showNotification('âœ“ YAML synchronized to UI successfully', 'success');

                } catch (error) {
                    // Show error with details
                    this.showYAMLError(error);
                }
            },

            /**
             * Simple YAML parser for DataK9 config structure
             * Handles the specific YAML format used by DataK9
             */
            parseYAML(yamlText) {
                try {
                    const lines = yamlText.split('\n');
                    const config = { validation_job: { files: [] } };
                    let currentContext = config;
                    let currentFile = null;
                    let currentValidation = null;
                    let currentCondition = null;
                    let indentStack = [{ level: 0, context: config }];
                    let inSettings = false;

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        const trimmed = line.trim();

                        // Skip empty lines and comments
                        if (!trimmed || trimmed.startsWith('#')) continue;

                        // Calculate indentation level
                        const indent = line.search(/\S/);

                        // Parse key-value pairs
                        const match = trimmed.match(/^([a-zA-Z_][a-zA-Z0-9_]*)\s*:\s*(.*)$/);
                        if (!match) {
                            // Handle list items
                            if (trimmed.startsWith('- ')) {
                                const listMatch = trimmed.match(/^-\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*:\s*(.*)$/);
                                if (listMatch) {
                                    const [, key, value] = listMatch;

                                    // Determine what kind of list item this is
                                    if (key === 'name' && currentContext === config.validation_job) {
                                        // New file
                                        currentFile = { name: this.unquoteValue(value), validations: [] };
                                        config.validation_job.files.push(currentFile);
                                        currentContext = currentFile;
                                    } else if (key === 'type' && currentFile) {
                                        // New validation
                                        currentValidation = { type: this.unquoteValue(value) };
                                        currentFile.validations.push(currentValidation);
                                        currentContext = currentValidation;
                                    }
                                }
                            }
                            continue;
                        }

                        const [, key, value] = match;
                        const unquotedValue = this.unquoteValue(value);

                        // Handle different sections
                        if (key === 'validation_job') {
                            currentContext = config.validation_job;
                            inSettings = false;
                        } else if (key === 'name' && indent === 2) {
                            config.validation_job.name = unquotedValue;
                        } else if (key === 'description' && indent === 2) {
                            config.validation_job.description = unquotedValue;
                        } else if (key === 'settings') {
                            inSettings = true;
                            if (!config.validation_job.settings) {
                                config.validation_job.settings = {};
                            }
                            currentContext = config.validation_job.settings;
                        } else if (key === 'files') {
                            currentContext = config.validation_job;
                        } else if (key === 'validations') {
                            if (currentFile) {
                                currentContext = currentFile;
                            }
                        } else if (inSettings && indent === 4) {
                            // Settings values
                            config.validation_job.settings[key] = this.parseValue(unquotedValue);
                        } else if (currentFile && !currentValidation && indent === 4 && (key === 'path' || key === 'format')) {
                            // File properties (path, format)
                            currentFile[key] = unquotedValue;
                        } else if (currentValidation && indent >= 8) {
                            // Validation parameters
                            if (key === 'condition') {
                                currentValidation.condition = {};
                                currentCondition = currentValidation.condition;
                            } else if (currentCondition && indent >= 10) {
                                // Condition parameters
                                currentCondition[key] = this.parseValue(unquotedValue);
                            } else {
                                currentValidation[key] = this.parseValue(unquotedValue);
                            }
                        }
                    }

                    return config;

                } catch (error) {
                    throw new Error(`YAML parsing failed: ${error.message}`);
                }
            },

            /**
             * Remove quotes from YAML values
             */
            unquoteValue(value) {
                if (!value) return '';
                const trimmed = value.trim();
                if ((trimmed.startsWith('"') && trimmed.endsWith('"')) ||
                    (trimmed.startsWith("'") && trimmed.endsWith("'"))) {
                    return trimmed.slice(1, -1);
                }
                return trimmed;
            },

            /**
             * Parse value to appropriate type
             */
            parseValue(value) {
                if (value === 'true') return true;
                if (value === 'false') return false;
                if (value === 'null' || value === '~') return null;
                if (/^-?\d+$/.test(value)) return parseInt(value, 10);
                if (/^-?\d+\.\d+$/.test(value)) return parseFloat(value);
                return value;
            },

            /**
             * Show YAML error modal with details
             */
            showYAMLError(error) {
                const errorMsg = error.message || 'Unknown error';

                // Create error modal content
                const modalContent = `
                    <div style="padding: 24px; max-width: 600px;">
                        <h2 style="color: var(--color-error); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">âš </span>
                            <span>YAML Sync Error</span>
                        </h2>
                        <div style="background: var(--bg-main); padding: 16px; border-radius: 4px; border-left: 3px solid var(--color-error); margin-bottom: 16px;">
                            <p style="margin: 0; color: var(--text-primary); font-family: monospace; font-size: 13px; white-space: pre-wrap;">${this.escapeHtml(errorMsg)}</p>
                        </div>
                        <div style="color: var(--text-muted); font-size: 13px; line-height: 1.6;">
                            <p><strong>Common issues:</strong></p>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li>Missing required 'validation_job' key</li>
                                <li>Incorrect indentation (use 2 or 4 spaces)</li>
                                <li>Missing colons after keys</li>
                                <li>Unquoted values with special characters</li>
                            </ul>
                            <p style="margin-top: 12px;">Fix the YAML syntax and try syncing again.</p>
                        </div>
                        <div style="margin-top: 24px; text-align: right;">
                            <button class="btn btn-primary" onclick="app.closeModal('yaml-error-modal')">OK</button>
                        </div>
                    </div>
                `;

                // Show error in a modal
                const modal = document.getElementById('yaml-error-modal');
                if (modal) {
                    document.getElementById('yaml-error-content').innerHTML = modalContent;
                    this.openModal('yaml-error-modal');
                } else {
                    // Fallback to alert if modal doesn't exist
                    alert('YAML Sync Error:\n\n' + errorMsg);
                }
            },

            /**
             * Show notification message
             */
            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    background: ${type === 'success' ? 'var(--color-success)' : type === 'error' ? 'var(--color-error)' : 'var(--color-primary)'};
                    color: white;
                    border-radius: 4px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10000;
                    font-size: 14px;
                    max-width: 400px;
                    animation: slideIn 0.3s ease-out;
                `;
                notification.textContent = message;

                // Add to document
                document.body.appendChild(notification);

                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            },

            /* ====================================================================
               Catalog
               ==================================================================== */

            openCatalog() {
                this.openModal('catalog-modal');
                this.renderValidationCatalog('catalog');
            },

            /* ====================================================================
               Modal Management
               ==================================================================== */

            openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
            },

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            },

            /* ====================================================================
               Menu Actions
               ==================================================================== */

            /* ====================================================================
               Menu System (Phase 5)
               ==================================================================== */

            toggleMenu(menuName) {
                const menuId = `${menuName}-menu`;
                const menuElement = document.getElementById(menuId);

                // Close other menus
                document.querySelectorAll('.menu-item').forEach(item => {
                    if (item.id !== menuId) {
                        item.classList.remove('active');
                    }
                });

                // Toggle this menu
                menuElement.classList.toggle('active');
            },

            closeAllMenus() {
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
            },

            showValidationCatalog() {
                // Show all validations in the output panel
                const categories = {};
                for (const [type, val] of Object.entries(this.validationLibrary)) {
                    const cat = val.category || 'Other';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(val);
                }

                let html = '<div style="max-height: 600px; overflow-y: auto; padding: 20px;">';
                html += '<h2 style="margin-top: 0; color: var(--color-primary);">Validation Catalog</h2>';
                html += '<p style="color: var(--text-secondary); margin-bottom: 20px;">All available validation types organized by category</p>';

                for (const [category, validations] of Object.entries(categories)) {
                    html += `<h3 style="color: var(--color-primary); margin-top: 24px; margin-bottom: 12px;">${category}</h3>`;
                    html += '<div style="display: grid; gap: 10px;">';
                    for (const val of validations) {
                        html += `
                            <div style="border: 1px solid var(--border-main); padding: 12px; border-radius: 4px;">
                                <div style="font-weight: bold; margin-bottom: 4px;">
                                    ${val.icon} ${val.name}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ${val.description}
                                </div>
                            </div>
                        `;
                    }
                    html += '</div>';
                }
                html += '</div>';

                // Show in output panel and ensure it's visible
                document.getElementById('output-content').innerHTML = html;
                panelManager.showPanel('bottom-panel');
            },

            showKeyboardShortcuts() {
                const shortcuts = [
                    { key: 'Ctrl+N', action: 'New Project' },
                    { key: 'Ctrl+O', action: 'Open Project' },
                    { key: 'Ctrl+S', action: 'Export YAML (Project)' },
                    { key: 'Ctrl+R', action: 'Sync from YAML' },
                    { key: 'Ctrl+B', action: 'Toggle Sidebar' },
                    { key: 'Ctrl+J', action: 'Toggle Footer' },
                    { key: 'Ctrl+Up', action: 'Move Validation Up' },
                    { key: 'Ctrl+Down', action: 'Move Validation Down' },
                    { key: 'Delete', action: 'Delete Selected Item' }
                ];

                let html = '<div style="max-height: 600px; overflow-y: auto; padding: 20px;">';
                html += '<h2 style="color: var(--color-primary); margin-bottom: 20px;">Keyboard Shortcuts</h2>';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="border-bottom: 2px solid var(--border-main);"><th style="text-align: left; padding: 8px;">Shortcut</th><th style="text-align: left; padding: 8px;">Action</th></tr></thead>';
                html += '<tbody>';
                for (const shortcut of shortcuts) {
                    html += `
                        <tr style="border-bottom: 1px solid var(--border-subtle);">
                            <td style="padding: 8px; font-family: monospace; color: var(--color-primary);">${shortcut.key}</td>
                            <td style="padding: 8px;">${shortcut.action}</td>
                        </tr>
                    `;
                }
                html += '</tbody></table></div>';

                document.getElementById('output-content').innerHTML = html;
                panelManager.showPanel('bottom');
            },

            showAbout() {
                this.openModal('about-modal');
            },

            /* ====================================================================
               Export Documentation (Phase 2)
               ==================================================================== */

            /**
             * Open export documentation dialog
             */
            openExportDocsDialog() {
                this.openModal('export-docs-modal');

                // Setup format change listener to show/hide theme selector
                const formatSelect = document.getElementById('export-format');
                const themeSelector = document.getElementById('theme-selector');

                formatSelect.onchange = () => {
                    themeSelector.style.display = formatSelect.value === 'html' ? 'block' : 'none';
                };
            },

            /**
             * Generate documentation based on user selections
             */
            generateDocumentation() {
                const format = document.getElementById('export-format').value;
                const theme = document.getElementById('export-theme').value;
                const options = {
                    includeProjectInfo: document.getElementById('include-project-info').checked,
                    includeFiles: document.getElementById('include-files').checked,
                    includeValidations: document.getElementById('include-validations').checked,
                    includeParams: document.getElementById('include-params').checked,
                    includeExamples: document.getElementById('include-examples').checked
                };

                const config = this.config;

                if (!config.job_name && !config.validation_job?.name) {
                    alert('Please create a project first before exporting documentation.');
                    return;
                }

                try {
                    if (format === 'html') {
                        this.generateHTMLDocumentation(config, theme, options);
                    } else {
                        this.generateMarkdownDocumentation(config, options);
                    }

                    this.closeModal('export-docs-modal');
                } catch (error) {
                    console.error('Error generating documentation:', error);
                    alert('Error generating documentation: ' + error.message);
                }
            },

            /**
             * Generate HTML documentation
             */
            generateHTMLDocumentation(config, theme, options) {
                const projectName = config.validation_job?.name || config.job_name || 'Untitled Project';
                const description = config.validation_job?.description || config.description || '';

                // Generate default filename
                const defaultFilename = `${projectName.replace(/\s+/g, '_')}_validation_spec.html`;

                // Prompt user for filename
                const filename = prompt('Enter filename for HTML documentation:', defaultFilename);
                if (!filename) return; // User cancelled

                // Ensure .html extension
                const finalFilename = filename.endsWith('.html') || filename.endsWith('.htm')
                    ? filename
                    : `${filename}.html`;

                const styles = theme === 'dark' ? this.getDarkThemeCSS() : this.getLightThemeCSS();

                let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${projectName} - Validation Documentation</title>
    <style>${styles}</style>
</head>
<body>
    <div class="container">
        <header class="doc-header">
            <h1>${projectName}</h1>
            ${description ? `<p class="doc-description">${description}</p>` : ''}
        </header>

        ${options.includeProjectInfo ? this.generateProjectInfoSection(config) : ''}
        ${options.includeFiles ? this.generateFilesSection(config, options) : ''}
    </div>
</body>
</html>`;

                this.downloadFile(html, finalFilename, 'text/html');
            },

            /**
             * Generate Markdown documentation
             */
            generateMarkdownDocumentation(config, options) {
                const projectName = config.validation_job?.name || config.job_name || 'Untitled Project';
                const description = config.validation_job?.description || config.description || '';

                // Generate default filename
                const defaultFilename = `${projectName.replace(/\s+/g, '_')}_validation_spec.md`;

                // Prompt user for filename
                const filename = prompt('Enter filename for Markdown documentation:', defaultFilename);
                if (!filename) return; // User cancelled

                // Ensure .md extension
                const finalFilename = filename.endsWith('.md') || filename.endsWith('.markdown')
                    ? filename
                    : `${filename}.md`;

                let md = `# ${projectName}\n\n`;

                if (description) {
                    md += `${description}\n\n`;
                }

                if (options.includeProjectInfo) {
                    md += this.generateProjectInfoMarkdown(config);
                }

                if (options.includeFiles) {
                    md += this.generateFilesMarkdown(config, options);
                }

                this.downloadFile(md, finalFilename, 'text/markdown');
            },

            /**
             * Generate project info section for HTML
             */
            generateProjectInfoSection(config) {
                const settings = config.validation_job?.settings || config.settings || {};

                return `
        <section class="doc-section">
            <h2>Configuration</h2>
            <table class="info-table">
                <tr>
                    <th>Setting</th>
                    <th>Value</th>
                </tr>
                <tr>
                    <td>Chunk Size</td>
                    <td>${settings.chunk_size || 50000}</td>
                </tr>
                <tr>
                    <td>Max Sample Failures</td>
                    <td>${settings.max_sample_failures || 100}</td>
                </tr>
                <tr>
                    <td>Log Level</td>
                    <td>${settings.log_level || 'INFO'}</td>
                </tr>
            </table>
        </section>`;
            },

            /**
             * Generate files section for HTML
             */
            generateFilesSection(config, options) {
                const files = config.validation_job?.files || config.files || [];

                if (files.length === 0) {
                    return '<section class="doc-section"><h2>Data Files</h2><p class="no-data">No files configured</p></section>';
                }

                let html = '<section class="doc-section"><h2>Data Files</h2>';

                files.forEach((file, index) => {
                    html += `
            <div class="file-card">
                <h3>${file.name}</h3>
                <p><strong>Path:</strong> <code>${file.path}</code></p>
                <p><strong>Format:</strong> ${file.format ? file.format.toUpperCase() : 'Not specified'}</p>

                ${options.includeValidations && file.validations?.length > 0 ?
                    this.generateValidationsHTML(file.validations, options) : ''}
            </div>`;
                });

                html += '</section>';
                return html;
            },

            /**
             * Generate validations HTML
             */
            generateValidationsHTML(validations, options) {
                let html = '<div class="validations-list"><h4>Validation Rules</h4>';

                validations.forEach((validation, idx) => {
                    const def = this.validationLibrary[validation.type];
                    if (!def) return;

                    html += `
                <div class="validation-item">
                    <div class="validation-header">
                        <span class="validation-name"><strong>${idx + 1}. ${def.name}</strong></span>
                        <span class="severity-badge severity-${(validation.severity || 'WARNING').toLowerCase()}">${validation.severity || 'WARNING'}</span>
                    </div>
                    <p class="validation-desc">${def.description}</p>`;

                    if (options.includeParams && validation.params && Object.keys(validation.params).length > 0) {
                        html += '<div class="params-list"><strong>Parameters:</strong><ul>';
                        for (const [key, value] of Object.entries(validation.params)) {
                            html += `<li><code>${key}</code>: ${this.formatParamValue(value)}</li>`;
                        }
                        html += '</ul></div>';
                    }

                    html += '</div>';
                });

                html += '</div>';
                return html;
            },

            /**
             * Format parameter value for display
             */
            formatParamValue(value) {
                if (Array.isArray(value)) {
                    return `[${value.join(', ')}]`;
                } else if (typeof value === 'object' && value !== null) {
                    return JSON.stringify(value);
                } else {
                    return String(value);
                }
            },

            /**
             * Generate project info markdown
             */
            generateProjectInfoMarkdown(config) {
                const settings = config.validation_job?.settings || config.settings || {};

                let md = `## Configuration\n\n`;
                md += `| Setting | Value |\n`;
                md += `|---------|-------|\n`;
                md += `| Chunk Size | ${settings.chunk_size || 50000} |\n`;
                md += `| Max Sample Failures | ${settings.max_sample_failures || 100} |\n`;
                md += `| Log Level | ${settings.log_level || 'INFO'} |\n\n`;

                return md;
            },

            /**
             * Generate files markdown
             */
            generateFilesMarkdown(config, options) {
                const files = config.validation_job?.files || config.files || [];

                if (files.length === 0) {
                    return `## Data Files\n\nNo files configured.\n\n`;
                }

                let md = `## Data Files\n\n`;

                files.forEach((file, index) => {
                    md += `### ${file.name}\n\n`;
                    md += `- **Path**: \`${file.path}\`\n`;
                    md += `- **Format**: ${file.format ? file.format.toUpperCase() : 'Not specified'}\n\n`;

                    if (options.includeValidations && file.validations?.length > 0) {
                        md += this.generateValidationsMarkdown(file.validations, options);
                    }
                });

                return md;
            },

            /**
             * Generate validations markdown
             */
            generateValidationsMarkdown(validations, options) {
                let md = `#### Validation Rules\n\n`;

                validations.forEach((validation, idx) => {
                    const def = this.validationLibrary[validation.type];
                    if (!def) return;

                    md += `**${idx + 1}. ${def.name}** (${validation.severity || 'WARNING'})\n\n`;
                    md += `${def.description}\n\n`;

                    if (options.includeParams && validation.params && Object.keys(validation.params).length > 0) {
                        md += `**Parameters:**\n`;
                        for (const [key, value] of Object.entries(validation.params)) {
                            md += `- \`${key}\`: ${this.formatParamValue(value)}\n`;
                        }
                        md += `\n`;
                    }
                });

                return md;
            },

            /**
             * Get dark theme CSS for HTML export
             */
            getDarkThemeCSS() {
                return `
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1E1E1E; color: #D4D4D4; line-height: 1.6; }
                    .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
                    .doc-header { text-align: center; margin-bottom: 48px; padding-bottom: 24px; border-bottom: 2px solid #3E3E42; }
                    .doc-logo { font-size: 64px; margin-bottom: 16px; }
                    h1 { font-size: 36px; color: #4A90E2; margin-bottom: 8px; }
                    .doc-description { font-size: 18px; color: #858585; margin-top: 8px; }
                    .doc-meta { font-size: 14px; color: #6A6A6A; margin-top: 8px; }
                    .doc-section { margin-bottom: 40px; }
                    h2 { font-size: 28px; color: #4A90E2; margin-bottom: 16px; }
                    h3 { font-size: 22px; color: #D4D4D4; margin-bottom: 12px; margin-top: 20px; }
                    h4 { font-size: 18px; color: #858585; margin-bottom: 8px; }
                    .info-table { width: 100%; border-collapse: collapse; margin: 16px 0; background: #252526; border-radius: 8px; overflow: hidden; }
                    .info-table th, .info-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #3E3E42; }
                    .info-table th { background: #2A2D2E; color: #4A90E2; font-weight: 600; }
                    .info-table tr:last-child td { border-bottom: none; }
                    code { background: #3C3C3C; padding: 2px 6px; border-radius: 3px; font-family: 'Consolas', monospace; font-size: 13px; color: #4EC9B0; }
                    .file-card { background: #252526; padding: 24px; border-radius: 8px; margin-bottom: 24px; border: 1px solid #3E3E42; }
                    .no-data { color: #858585; font-style: italic; }
                    .validations-list { margin-top: 20px; }
                    .validation-item { background: #2A2D2E; padding: 16px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #4A90E2; }
                    .validation-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
                    .validation-icon { font-size: 20px; }
                    .validation-name { font-weight: 600; color: #D4D4D4; }
                    .severity-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
                    .severity-error { background: #F48771; color: #1E1E1E; }
                    .severity-warning { background: #DCDCAA; color: #1E1E1E; }
                    .validation-desc { color: #858585; font-size: 14px; margin-bottom: 8px; }
                    .params-list { margin-top: 8px; padding: 12px; background: #1E1E1E; border-radius: 4px; }
                    .params-list ul { margin-left: 20px; margin-top: 4px; }
                    .params-list li { margin-bottom: 4px; color: #858585; }
                    .example-box { margin-top: 8px; padding: 12px; background: #1E1E1E; border-radius: 4px; border-left: 3px solid #FF8C42; font-size: 14px; color: #858585; }
                    .doc-footer { margin-top: 60px; padding-top: 24px; border-top: 2px solid #3E3E42; text-align: center; color: #6A6A6A; }
                `;
            },

            /**
             * Get light theme CSS for HTML export
             */
            getLightThemeCSS() {
                return `
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #FFFFFF; color: #333333; line-height: 1.6; }
                    .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
                    .doc-header { text-align: center; margin-bottom: 48px; padding-bottom: 24px; border-bottom: 2px solid #E0E0E0; }
                    .doc-logo { font-size: 64px; margin-bottom: 16px; }
                    h1 { font-size: 36px; color: #2563EB; margin-bottom: 8px; }
                    .doc-description { font-size: 18px; color: #666666; margin-top: 8px; }
                    .doc-meta { font-size: 14px; color: #999999; margin-top: 8px; }
                    .doc-section { margin-bottom: 40px; }
                    h2 { font-size: 28px; color: #2563EB; margin-bottom: 16px; }
                    h3 { font-size: 22px; color: #333333; margin-bottom: 12px; margin-top: 20px; }
                    h4 { font-size: 18px; color: #666666; margin-bottom: 8px; }
                    .info-table { width: 100%; border-collapse: collapse; margin: 16px 0; background: #F8F9FA; border-radius: 8px; overflow: hidden; border: 1px solid #E0E0E0; }
                    .info-table th, .info-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #E0E0E0; }
                    .info-table th { background: #F0F0F0; color: #2563EB; font-weight: 600; }
                    .info-table tr:last-child td { border-bottom: none; }
                    code { background: #F0F0F0; padding: 2px 6px; border-radius: 3px; font-family: 'Consolas', monospace; font-size: 13px; color: #059669; }
                    .file-card { background: #F8F9FA; padding: 24px; border-radius: 8px; margin-bottom: 24px; border: 1px solid #E0E0E0; }
                    .no-data { color: #999999; font-style: italic; }
                    .validations-list { margin-top: 20px; }
                    .validation-item { background: #FFFFFF; padding: 16px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #2563EB; border: 1px solid #E0E0E0; }
                    .validation-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
                    .validation-icon { font-size: 20px; }
                    .validation-name { font-weight: 600; color: #333333; }
                    .severity-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
                    .severity-error { background: #DC2626; color: #FFFFFF; }
                    .severity-warning { background: #F59E0B; color: #FFFFFF; }
                    .validation-desc { color: #666666; font-size: 14px; margin-bottom: 8px; }
                    .params-list { margin-top: 8px; padding: 12px; background: #F8F9FA; border-radius: 4px; border: 1px solid #E0E0E0; }
                    .params-list ul { margin-left: 20px; margin-top: 4px; }
                    .params-list li { margin-bottom: 4px; color: #666666; }
                    .example-box { margin-top: 8px; padding: 12px; background: #FEF3C7; border-radius: 4px; border-left: 3px solid #F59E0B; font-size: 14px; color: #92400E; }
                    .doc-footer { margin-top: 60px; padding-top: 24px; border-top: 2px solid #E0E0E0; text-align: center; color: #999999; }
                `;
            },

            /**
             * Download file helper
             */
            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                console.log(`Documentation exported: ${filename}`);
            },

            /* ====================================================================
               Project State Management (Phase 3)
               ==================================================================== */

            /**
             * Update project state and UI accordingly
             */
            updateProjectState(isOpen, path = null) {
                this.projectState.isOpen = isOpen;
                this.projectState.projectPath = path;

                if (isOpen) {
                    this.projectState.lastSaved = new Date();
                }

                // Update UI to reflect state
                this.updateUIState();
                this.updateStatusBar();

                console.log(`Project state updated: ${isOpen ? 'Open' : 'Closed'}`, path || '');
            },

            /**
             * Mark project as having unsaved changes
             */
            markUnsavedChanges() {
                if (!this.projectState.hasUnsavedChanges) {
                    this.projectState.hasUnsavedChanges = true;
                    this.updateStatusBar();
                    console.log('Project marked as having unsaved changes');
                }
            },

            /**
             * Mark project as saved
             */
            markSaved() {
                this.projectState.hasUnsavedChanges = false;
                this.projectState.lastSaved = new Date();
                this.updateStatusBar();
                console.log('Project marked as saved');
            },

            /**
             * Update UI elements based on project state
             */
            updateUIState() {
                const disabled = !this.projectState.isOpen;
                const welcomeScreen = document.getElementById('welcome-screen');
                const editorView = document.getElementById('editor-view');
                const visualEditor = document.getElementById('visual-editor');
                const yamlPanel = document.getElementById('yaml-editor-panel');

                // Show/hide welcome screen and editor view
                if (welcomeScreen) {
                    welcomeScreen.classList.toggle('hidden', !disabled);
                }
                if (editorView) {
                    editorView.classList.toggle('hidden', disabled);
                }

                // Show/hide editor panels (for finer control within editor-view)
                if (visualEditor) {
                    visualEditor.style.display = disabled ? 'none' : 'block';
                }
                if (yamlPanel) {
                    yamlPanel.style.display = disabled ? 'none' : 'flex';
                }

                // Note: File operations buttons are controlled by their onclick handlers
                // which will check projectState.isOpen before executing
            },

            /**
             * Mark project as modified (for tracking export status)
             */
            markAsModified() {
                this.projectState.lastModified = Date.now();
                this.saveToLocalStorage();
                this.updateStatusBar();
            },

            /**
             * Update status bar with current project state
             */
            updateStatusBar() {
                // Update project name with export status
                const projectStatus = document.querySelector('#project-status .footer-item-value');
                if (projectStatus) {
                    const projectName = this.config.validation_job?.name || 'No project';

                    if (!this.projectState.isOpen) {
                        projectStatus.textContent = 'No project';
                    } else if (!this.projectState.hasExportedYAML) {
                        // Never exported
                        projectStatus.textContent = `${projectName} âš ï¸ Not exported yet`;
                    } else if (this.projectState.lastModified > this.projectState.lastExported) {
                        // Changed since last export
                        projectStatus.textContent = `${projectName} âš ï¸ Changes since export`;
                    } else {
                        // Up to date
                        projectStatus.textContent = `${projectName} âœ“`;
                    }
                }

                // Update file count
                const filesCount = document.querySelector('#files-count .footer-item-value');
                if (filesCount) {
                    filesCount.textContent = this.config.files?.length || 0;
                }

                // Update validation count
                const validationsCount = document.querySelector('#validations-count .footer-item-value');
                if (validationsCount) {
                    let total = 0;
                    (this.config.files || []).forEach(file => {
                        total += file.validations?.length || 0;
                    });
                    validationsCount.textContent = total;
                }
            },

            /**
             * Check for unsaved changes before action
             * Returns true if OK to proceed, false if cancelled
             */
            checkUnsavedChanges(action = 'continue') {
                if (this.projectState.hasUnsavedChanges) {
                    return confirm(
                        `You have unsaved changes.\n\n` +
                        `Do you want to ${action} without saving?\n\n` +
                        `Click OK to ${action} anyway, or Cancel to go back and save.`
                    );
                }
                return true;
            },

            /**
             * Check if project is open before operation
             */
            requireProject(operationName = 'this operation') {
                if (!this.projectState.isOpen) {
                    alert(`Please create or open a project before ${operationName}.`);
                    return false;
                }
                return true;
            },

            /* ====================================================================
               LocalStorage Persistence
               ==================================================================== */

            saveToLocalStorage() {
                try {
                    localStorage.setItem('datak9-config', JSON.stringify(this.config));
                    console.log('Configuration saved to localStorage');
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                }
            },

            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('datak9-config');
                    if (saved) {
                        const parsed = JSON.parse(saved);

                        // Phase 1: Validate structure before loading
                        if (!this.validateConfigStructure(parsed)) {
                            console.error('Invalid config structure detected, resetting to defaults');
                            localStorage.removeItem('datak9-config');
                            return;
                        }

                        // Phase 1: Sanitize all string values to prevent XSS
                        this.config = this.sanitizeConfig(parsed);
                        console.log('Configuration loaded and sanitized from localStorage');
                    }
                } catch (e) {
                    console.error('Failed to load from localStorage:', e);
                    // Remove corrupt data
                    localStorage.removeItem('datak9-config');
                }
            }
        };

        /* ========================================================================
           Panel Manager - Resizable, Collapsible, Responsive Panels
           ========================================================================

           This object manages all panel resize, collapse, and mobile functionality:
           - Drag-to-resize panels with min/max constraints
           - Collapse/expand panels with smooth animations
           - Mobile responsive layout with drawer/modal panels
           - LocalStorage persistence of panel states
           - Keyboard shortcuts for panel toggles
           - Touch support for mobile devices

           Version: 2.0.0
        */
        const panelManager = {
            // Panel size constraints (in pixels)
            constraints: {
                sidebar: { min: 200, max: 600, default: 280 },
                helpPanel: { min: 250, max: 600, default: 320 },
                bottomPanel: { min: 150, max: 400, default: 200 }
            },

            // Current panel sizes (initialized from localStorage or defaults)
            panelSizes: {
                sidebar: 280,
                helpPanel: 320,
                bottomPanel: 200,
                yamlSplit: 50 // Percentage
            },

            // Panel collapsed states
            panelStates: {
                sidebarCollapsed: false,
                helpPanelCollapsed: false,
                bottomPanelCollapsed: false
            },

            // Mobile states
            mobileLayout: {
                sidebarOpen: false,
                helpPanelOpen: false,
                activeTab: 'visual' // 'visual' or 'yaml'
            },

            // Resize tracking
            resizing: {
                active: false,
                panel: null,
                startX: 0,
                startY: 0,
                startSize: 0
            },

            /* ====================================================================
               Initialization
               ==================================================================== */

            init() {
                console.log('Initializing Panel Manager...');

                // Load saved panel states from localStorage
                this.loadPanelState();

                // Apply initial panel sizes
                this.applyPanelSizes();

                // Initialize resize handles
                this.initializeResizeHandles();

                // Initialize keyboard shortcuts
                this.initializeKeyboardShortcuts();

                // Initialize mobile responsive behavior
                this.initializeResponsive();

                console.log('Panel Manager initialized successfully');
            },

            /* ====================================================================
               Panel Resizing
               ==================================================================== */

            initializeResizeHandles() {
                // Sidebar resize handle
                const sidebarHandle = document.querySelector('.resize-handle-sidebar');
                if (sidebarHandle) {
                    this.attachResizeEvents(sidebarHandle, 'sidebar', 'horizontal');
                }

                // Help panel resize handle
                const helpHandle = document.querySelector('.resize-handle-help');
                if (helpHandle) {
                    this.attachResizeEvents(helpHandle, 'helpPanel', 'horizontal');
                }

                // Bottom panel resize handle
                const bottomHandle = document.querySelector('.resize-handle-bottom');
                if (bottomHandle) {
                    this.attachResizeEvents(bottomHandle, 'bottomPanel', 'vertical');
                }

                // Editor split resize handle
                const splitHandle = document.getElementById('split-resize-handle');
                if (splitHandle) {
                    this.attachSplitResizeEvents(splitHandle);
                }
            },

            attachResizeEvents(handle, panelName, direction) {
                // Mouse events
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    this.startResize(e, panelName, direction);
                });

                // Touch events for mobile
                handle.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.startResize(touch, panelName, direction);
                }, { passive: false });
            },

            startResize(e, panelName, direction) {
                this.resizing.active = true;
                this.resizing.panel = panelName;
                this.resizing.direction = direction;
                this.resizing.startX = e.clientX;
                this.resizing.startY = e.clientY;
                this.resizing.startSize = this.panelSizes[panelName];

                // Add resizing class for visual feedback
                const handle = e.target;
                handle.classList.add('resizing');

                // Prevent text selection during resize
                document.body.style.userSelect = 'none';

                // Attach move and end events
                document.addEventListener('mousemove', this.handleResize);
                document.addEventListener('mouseup', this.endResize);
                document.addEventListener('touchmove', this.handleResizeTouch, { passive: false });
                document.addEventListener('touchend', this.endResize);
            },

            handleResize: (e) => {
                if (!panelManager.resizing.active) return;

                const { panel, direction, startX, startY, startSize } = panelManager.resizing;

                let delta = 0;
                if (direction === 'horizontal') {
                    delta = panel === 'sidebar' ? (e.clientX - startX) : (startX - e.clientX);
                } else {
                    delta = startY - e.clientY;
                }

                const newSize = Math.max(
                    panelManager.constraints[panel].min,
                    Math.min(panelManager.constraints[panel].max, startSize + delta)
                );

                panelManager.panelSizes[panel] = newSize;
                panelManager.applyPanelSize(panel, newSize);
            },

            handleResizeTouch: (e) => {
                if (!panelManager.resizing.active) return;
                e.preventDefault();

                const touch = e.touches[0];
                panelManager.handleResize(touch);
            },

            endResize: () => {
                if (!panelManager.resizing.active) return;

                // Remove resizing class
                const handles = document.querySelectorAll('.resize-handle.resizing, .resize-handle-split.resizing');
                handles.forEach(h => h.classList.remove('resizing'));

                // Re-enable text selection
                document.body.style.userSelect = '';

                // Save panel state to localStorage
                panelManager.savePanelState();

                // Clean up
                document.removeEventListener('mousemove', panelManager.handleResize);
                document.removeEventListener('mouseup', panelManager.endResize);
                document.removeEventListener('touchmove', panelManager.handleResizeTouch);
                document.removeEventListener('touchend', panelManager.endResize);

                panelManager.resizing.active = false;
                panelManager.resizing.panel = null;
            },

            attachSplitResizeEvents(handle) {
                let startX = 0;
                let startWidth = 0;
                let visualEditor = null;
                let yamlEditor = null;

                const startSplitResize = (e) => {
                    e.preventDefault();
                    visualEditor = document.getElementById('visual-editor');
                    yamlEditor = document.getElementById('yaml-editor-panel');

                    if (!visualEditor || !yamlEditor) return;

                    startX = e.clientX;
                    const editorView = document.getElementById('editor-view');
                    const totalWidth = editorView.offsetWidth;
                    startWidth = visualEditor.offsetWidth;

                    handle.classList.add('resizing');
                    document.body.style.userSelect = 'none';

                    document.addEventListener('mousemove', handleSplitMove);
                    document.addEventListener('mouseup', endSplitResize);
                };

                const handleSplitMove = (e) => {
                    if (!visualEditor || !yamlEditor) return;

                    const editorView = document.getElementById('editor-view');
                    const totalWidth = editorView.offsetWidth;
                    const delta = e.clientX - startX;
                    const newWidth = startWidth + delta;

                    // Calculate percentage (30% to 70% range)
                    const percentage = (newWidth / totalWidth) * 100;
                    const clampedPercentage = Math.max(30, Math.min(70, percentage));

                    visualEditor.style.flex = `0 0 ${clampedPercentage}%`;
                    yamlEditor.style.flex = `0 0 ${100 - clampedPercentage}%`;

                    panelManager.panelSizes.yamlSplit = clampedPercentage;
                };

                const endSplitResize = () => {
                    handle.classList.remove('resizing');
                    document.body.style.userSelect = '';

                    document.removeEventListener('mousemove', handleSplitMove);
                    document.removeEventListener('mouseup', endSplitResize);

                    panelManager.savePanelState();
                };

                handle.addEventListener('mousedown', startSplitResize);

                // Touch support
                handle.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    startSplitResize(touch);
                }, { passive: false });
            },

            applyPanelSizes() {
                this.applyPanelSize('sidebar', this.panelSizes.sidebar);
                this.applyPanelSize('helpPanel', this.panelSizes.helpPanel);
                this.applyPanelSize('bottomPanel', this.panelSizes.bottomPanel);

                // Apply split percentage
                const visualEditor = document.getElementById('visual-editor');
                const yamlEditor = document.getElementById('yaml-editor-panel');
                if (visualEditor && yamlEditor) {
                    const splitPercent = this.panelSizes.yamlSplit;
                    visualEditor.style.flex = `0 0 ${splitPercent}%`;
                    yamlEditor.style.flex = `0 0 ${100 - splitPercent}%`;
                }
            },

            applyPanelSize(panelName, size) {
                let element = null;
                let property = 'width';

                if (panelName === 'sidebar') {
                    element = document.getElementById('sidebar');
                } else if (panelName === 'helpPanel') {
                    element = document.getElementById('help-panel');
                } else if (panelName === 'bottomPanel') {
                    element = document.getElementById('bottom-panel');
                    property = 'height';
                }

                if (element && !this.panelStates[panelName + 'Collapsed']) {
                    element.style[property] = size + 'px';
                }
            },

            /* ====================================================================
               Panel Collapse/Expand
               ==================================================================== */

            togglePanel(panelId) {
                const panel = document.getElementById(panelId);
                if (!panel) return;

                const isCollapsed = panel.classList.contains('collapsed');

                if (isCollapsed) {
                    this.expandPanel(panelId);
                } else {
                    this.collapsePanel(panelId);
                }

                // Save state
                this.savePanelState();

                // Announce to screen readers
                const action = isCollapsed ? 'expanded' : 'collapsed';
                console.log(`Panel ${panelId} ${action}`);
            },

            collapsePanel(panelId) {
                const panel = document.getElementById(panelId);
                if (!panel) return;

                panel.classList.add('collapsed');

                // Update state
                if (panelId === 'sidebar') {
                    this.panelStates.sidebarCollapsed = true;
                } else if (panelId === 'help-panel') {
                    this.panelStates.helpPanelCollapsed = true;
                } else if (panelId === 'bottom-panel') {
                    this.panelStates.bottomPanelCollapsed = true;
                }
            },

            expandPanel(panelId) {
                const panel = document.getElementById(panelId);
                if (!panel) return;

                panel.classList.remove('collapsed');

                // Restore size
                if (panelId === 'sidebar') {
                    this.panelStates.sidebarCollapsed = false;
                    this.applyPanelSize('sidebar', this.panelSizes.sidebar);
                } else if (panelId === 'help-panel') {
                    this.panelStates.helpPanelCollapsed = false;
                    this.applyPanelSize('helpPanel', this.panelSizes.helpPanel);
                } else if (panelId === 'bottom-panel') {
                    this.panelStates.bottomPanelCollapsed = false;
                    this.applyPanelSize('bottomPanel', this.panelSizes.bottomPanel);
                }
            },

            /* ====================================================================
               Keyboard Shortcuts
               ==================================================================== */

            initializeKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Ctrl+B - Toggle sidebar
                    if (e.ctrlKey && e.key === 'b') {
                        e.preventDefault();
                        this.togglePanel('sidebar');
                    }

                    // Ctrl+H - Toggle help panel
                    if (e.ctrlKey && e.key === 'h') {
                        e.preventDefault();
                        this.togglePanel('help-panel');
                    }

                    // Ctrl+J - Toggle bottom panel
                    if (e.ctrlKey && e.key === 'j') {
                        e.preventDefault();
                        this.togglePanel('bottom-panel');
                    }
                });
            },

            /* ====================================================================
               Mobile Responsive
               ==================================================================== */

            initializeResponsive() {
                // Listen for window resize to handle responsive breakpoints
                window.addEventListener('resize', () => {
                    this.handleResponsiveLayout();
                });

                // Initial layout setup
                this.handleResponsiveLayout();
            },

            handleResponsiveLayout() {
                const isMobile = window.innerWidth < 768;

                if (isMobile) {
                    // Apply mobile layout
                    this.applyMobileLayout();
                } else {
                    // Apply desktop layout
                    this.applyDesktopLayout();
                }
            },

            applyMobileLayout() {
                // Close any open mobile panels
                this.closeMobilePanels();

                // Ensure correct mobile tab is active
                this.updateMobileTabs();
            },

            applyDesktopLayout() {
                // Remove mobile classes
                const sidebar = document.getElementById('sidebar');
                const helpPanel = document.getElementById('help-panel');
                const overlay = document.getElementById('sidebar-overlay');

                if (sidebar) sidebar.classList.remove('mobile-open');
                if (helpPanel) helpPanel.classList.remove('mobile-open');
                if (overlay) overlay.classList.remove('active');

                // Show both visual and YAML editors
                const visualEditor = document.getElementById('visual-editor');
                const yamlPanel = document.getElementById('yaml-editor-panel');

                if (visualEditor) visualEditor.classList.remove('mobile-active');
                if (yamlPanel) yamlPanel.classList.remove('mobile-active');

                // Apply saved panel sizes
                this.applyPanelSizes();
            },

            toggleMobileSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');

                if (!sidebar || !overlay) return;

                const isOpen = sidebar.classList.contains('mobile-open');

                if (isOpen) {
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                    this.mobileLayout.sidebarOpen = false;
                } else {
                    sidebar.classList.add('mobile-open');
                    overlay.classList.add('active');
                    this.mobileLayout.sidebarOpen = true;
                }
            },

            toggleMobileHelp() {
                const helpPanel = document.getElementById('help-panel');
                const overlay = document.getElementById('sidebar-overlay');

                if (!helpPanel || !overlay) return;

                const isOpen = helpPanel.classList.contains('mobile-open');

                if (isOpen) {
                    helpPanel.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                    this.mobileLayout.helpPanelOpen = false;
                } else {
                    helpPanel.classList.add('mobile-open');
                    overlay.classList.add('active');
                    this.mobileLayout.helpPanelOpen = true;
                }
            },

            closeMobilePanels() {
                const sidebar = document.getElementById('sidebar');
                const helpPanel = document.getElementById('help-panel');
                const overlay = document.getElementById('sidebar-overlay');

                if (sidebar) sidebar.classList.remove('mobile-open');
                if (helpPanel) helpPanel.classList.remove('mobile-open');
                if (overlay) overlay.classList.remove('active');

                this.mobileLayout.sidebarOpen = false;
                this.mobileLayout.helpPanelOpen = false;
            },

            switchMobileTab(tab) {
                const visualEditor = document.getElementById('visual-editor');
                const yamlPanel = document.getElementById('yaml-editor-panel');
                const visualBtn = document.querySelector('.mobile-tab-btn[data-tab="visual"]');
                const yamlBtn = document.querySelector('.mobile-tab-btn[data-tab="yaml"]');

                if (!visualEditor || !yamlPanel) return;

                // Update active tab
                this.mobileLayout.activeTab = tab;

                // Update tab buttons
                if (visualBtn) visualBtn.classList.toggle('active', tab === 'visual');
                if (yamlBtn) yamlBtn.classList.toggle('active', tab === 'yaml');

                // Update editor visibility
                visualEditor.classList.toggle('mobile-active', tab === 'visual');
                yamlPanel.classList.toggle('mobile-active', tab === 'yaml');

                // Save state
                this.savePanelState();
            },

            updateMobileTabs() {
                const activeTab = this.mobileLayout.activeTab;
                this.switchMobileTab(activeTab);
            },

            /* ====================================================================
               LocalStorage Persistence
               ==================================================================== */

            savePanelState() {
                try {
                    const state = {
                        panelSizes: this.panelSizes,
                        panelStates: this.panelStates,
                        mobileLayout: this.mobileLayout
                    };
                    localStorage.setItem('datak9-panel-state', JSON.stringify(state));
                    console.log('Panel state saved to localStorage');
                } catch (e) {
                    console.error('Failed to save panel state:', e);
                }
            },

            loadPanelState() {
                try {
                    const saved = localStorage.getItem('datak9-panel-state');
                    if (saved) {
                        const state = JSON.parse(saved);

                        // Restore panel sizes
                        if (state.panelSizes) {
                            this.panelSizes = { ...this.panelSizes, ...state.panelSizes };
                        }

                        // Restore panel states
                        if (state.panelStates) {
                            this.panelStates = { ...this.panelStates, ...state.panelStates };

                            // Apply collapsed states
                            if (state.panelStates.sidebarCollapsed) {
                                setTimeout(() => this.collapsePanel('sidebar'), 100);
                            }
                            if (state.panelStates.helpPanelCollapsed) {
                                setTimeout(() => this.collapsePanel('help-panel'), 100);
                            }
                            if (state.panelStates.bottomPanelCollapsed) {
                                setTimeout(() => this.collapsePanel('bottom-panel'), 100);
                            }
                        }

                        // Restore mobile layout
                        if (state.mobileLayout) {
                            this.mobileLayout = { ...this.mobileLayout, ...state.mobileLayout };
                        }

                        console.log('Panel state loaded from localStorage');
                    }
                } catch (e) {
                    console.error('Failed to load panel state:', e);
                }
            }
        };

        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
            panelManager.init();
        });
    </script>
</body>
</html>